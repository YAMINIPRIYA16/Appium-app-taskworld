"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.hasContent = hasContent;
exports.hasValue = hasValue;
exports.escapeSpace = escapeSpace;
exports.escapeSpecialChars = escapeSpecialChars;
exports.localIp = localIp;
exports.cancellableDelay = cancellableDelay;
exports.multiResolve = multiResolve;
exports.safeJsonParse = safeJsonParse;
exports.wrapElement = wrapElement;
exports.unwrapElement = unwrapElement;
exports.filterObject = filterObject;
exports.toReadableSizeString = toReadableSizeString;
exports.isSubPath = isSubPath;
exports.isSameDestination = isSameDestination;
exports.compareVersions = compareVersions;
exports.coerceVersion = coerceVersion;
exports.quote = quote;
exports.unleakString = unleakString;
exports.jsonStringify = jsonStringify;
exports.W3C_WEB_ELEMENT_IDENTIFIER = void 0;

require("source-map-support/register");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _lodash = _interopRequireDefault(require("lodash"));

var _os = _interopRequireDefault(require("os"));

var _path = _interopRequireDefault(require("path"));

var _fs = _interopRequireDefault(require("./fs"));

var _semver = _interopRequireDefault(require("semver"));

var _shellQuote = require("shell-quote");

const W3C_WEB_ELEMENT_IDENTIFIER = 'element-6066-11e4-a52e-4f735466cecf';
exports.W3C_WEB_ELEMENT_IDENTIFIER = W3C_WEB_ELEMENT_IDENTIFIER;

function hasContent(val) {
  return _lodash.default.isString(val) && val !== '';
}

function hasValue(val) {
  let hasVal = false;

  if (_lodash.default.isNumber(val)) {
    hasVal = !_lodash.default.isNaN(val);
  } else {
    hasVal = !_lodash.default.isUndefined(val) && !_lodash.default.isNull(val);
  }

  return hasVal;
}

function escapeSpace(str) {
  return str.split(/ /).join('\\ ');
}

function escapeSpecialChars(str, quoteEscape) {
  if (typeof str !== 'string') {
    return str;
  }

  if (typeof quoteEscape === 'undefined') {
    quoteEscape = false;
  }

  str = str.replace(/[\\]/g, '\\\\').replace(/[\/]/g, '\\/').replace(/[\b]/g, '\\b').replace(/[\f]/g, '\\f').replace(/[\n]/g, '\\n').replace(/[\r]/g, '\\r').replace(/[\t]/g, '\\t').replace(/[\"]/g, '\\"').replace(/\\'/g, "\\'");

  if (quoteEscape) {
    let re = new RegExp(quoteEscape, 'g');
    str = str.replace(re, `\\${quoteEscape}`);
  }

  return str;
}

function localIp() {
  let ip = _lodash.default.chain(_os.default.networkInterfaces()).values().flatten().filter(function (val) {
    return val.family === 'IPv4' && val.internal === false;
  }).map('address').first().value();

  return ip;
}

function cancellableDelay(ms) {
  let timer;
  let resolve;
  let reject;
  const delay = new _bluebird.default.Promise((_resolve, _reject) => {
    resolve = _resolve;
    reject = _reject;
    timer = setTimeout(function () {
      resolve();
    }, ms);
  });

  delay.cancel = function () {
    clearTimeout(timer);
    reject(new _bluebird.default.CancellationError());
  };

  return delay;
}

function multiResolve(roots, ...args) {
  return roots.map(root => {
    return _path.default.resolve(root, ...args);
  });
}

function safeJsonParse(obj) {
  try {
    return JSON.parse(obj);
  } catch (ign) {
    return obj;
  }
}

function jsonStringify(obj, replacer, space = 2) {
  if (!_lodash.default.isFunction(replacer)) {
    replacer = (k, v) => v;
  }

  const bufferToJSON = Buffer.prototype.toJSON;
  delete Buffer.prototype.toJSON;

  try {
    return JSON.stringify(obj, (key, value) => {
      const updatedValue = Buffer.isBuffer(value) ? value.toString('utf8') : value;
      return replacer(key, updatedValue);
    }, space);
  } finally {
    Buffer.prototype.toJSON = bufferToJSON;
  }
}

function unwrapElement(el) {
  for (const propName of [W3C_WEB_ELEMENT_IDENTIFIER, 'ELEMENT']) {
    if (_lodash.default.has(el, propName)) {
      return el[propName];
    }
  }

  return el;
}

function wrapElement(elementId) {
  return {
    ELEMENT: elementId,
    [W3C_WEB_ELEMENT_IDENTIFIER]: elementId
  };
}

function filterObject(obj, predicate) {
  let newObj = _lodash.default.clone(obj);

  if (_lodash.default.isUndefined(predicate)) {
    predicate = v => !_lodash.default.isUndefined(v);
  } else if (!_lodash.default.isFunction(predicate)) {
    const valuePredicate = predicate;

    predicate = v => v === valuePredicate;
  }

  for (const key of Object.keys(obj)) {
    if (!predicate(obj[key], obj)) {
      delete newObj[key];
    }
  }

  return newObj;
}

function toReadableSizeString(bytes) {
  const intBytes = parseInt(bytes, 10);

  if (isNaN(intBytes) || intBytes < 0) {
    throw new Error(`Cannot convert '${bytes}' to a readable size format`);
  }

  if (intBytes >= 1024 * 1024 * 1024) {
    return `${parseFloat(intBytes / (1024 * 1024 * 1024.0)).toFixed(2)} GB`;
  } else if (intBytes >= 1024 * 1024) {
    return `${parseFloat(intBytes / (1024 * 1024.0)).toFixed(2)} MB`;
  } else if (intBytes >= 1024) {
    return `${parseFloat(intBytes / 1024.0).toFixed(2)} KB`;
  }

  return `${intBytes} B`;
}

function isSubPath(originalPath, root, forcePosix = null) {
  const pathObj = forcePosix ? _path.default.posix : _path.default;

  for (const p of [originalPath, root]) {
    if (!pathObj.isAbsolute(p)) {
      throw new Error(`'${p}' is expected to be an absolute path`);
    }
  }

  const normalizedRoot = pathObj.normalize(root);
  const normalizedPath = pathObj.normalize(originalPath);
  return normalizedPath.startsWith(normalizedRoot);
}

async function isSameDestination(path1, path2, ...pathN) {
  const allPaths = [path1, path2, ...pathN];

  if (!(await _bluebird.default.reduce(allPaths, async (a, b) => a && (await _fs.default.exists(b)), true))) {
    return false;
  }

  const areAllItemsEqual = arr => !!arr.reduce((a, b) => a === b ? a : NaN);

  if (areAllItemsEqual(allPaths)) {
    return true;
  }

  let mapCb = async x => await _fs.default.stat(x, {
    bigint: true
  }).ino;

  if (_semver.default.lt(process.version, '10.5.0')) {
    mapCb = async x => await _fs.default.stat(x).ino;
  }

  return areAllItemsEqual((await _bluebird.default.map(allPaths, mapCb)));
}

function coerceVersion(ver, strict = true) {
  const result = _semver.default.valid(_semver.default.coerce(`${ver}`));

  if (strict && !result) {
    throw new Error(`'${ver}' cannot be coerced to a valid version number`);
  }

  return result;
}

const SUPPORTED_OPERATORS = ['==', '!=', '>', '<', '>=', '<=', '='];

function compareVersions(ver1, operator, ver2) {
  if (!SUPPORTED_OPERATORS.includes(operator)) {
    throw new Error(`The '${operator}' comparison operator is not supported. ` + `Only '${JSON.stringify(SUPPORTED_OPERATORS)}' operators are supported`);
  }

  const semverOperator = ['==', '!='].includes(operator) ? '=' : operator;

  const result = _semver.default.satisfies(coerceVersion(ver1), `${semverOperator}${coerceVersion(ver2)}`);

  return operator === '!=' ? !result : result;
}

function quote(args) {
  return (0, _shellQuote.quote)(args);
}

function unleakString(s) {
  return ` ${s}`.substr(1);
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91dGlsLmpzIl0sIm5hbWVzIjpbIlczQ19XRUJfRUxFTUVOVF9JREVOVElGSUVSIiwiaGFzQ29udGVudCIsInZhbCIsIl8iLCJpc1N0cmluZyIsImhhc1ZhbHVlIiwiaGFzVmFsIiwiaXNOdW1iZXIiLCJpc05hTiIsImlzVW5kZWZpbmVkIiwiaXNOdWxsIiwiZXNjYXBlU3BhY2UiLCJzdHIiLCJzcGxpdCIsImpvaW4iLCJlc2NhcGVTcGVjaWFsQ2hhcnMiLCJxdW90ZUVzY2FwZSIsInJlcGxhY2UiLCJyZSIsIlJlZ0V4cCIsImxvY2FsSXAiLCJpcCIsImNoYWluIiwib3MiLCJuZXR3b3JrSW50ZXJmYWNlcyIsInZhbHVlcyIsImZsYXR0ZW4iLCJmaWx0ZXIiLCJmYW1pbHkiLCJpbnRlcm5hbCIsIm1hcCIsImZpcnN0IiwidmFsdWUiLCJjYW5jZWxsYWJsZURlbGF5IiwibXMiLCJ0aW1lciIsInJlc29sdmUiLCJyZWplY3QiLCJkZWxheSIsIkIiLCJQcm9taXNlIiwiX3Jlc29sdmUiLCJfcmVqZWN0Iiwic2V0VGltZW91dCIsImNhbmNlbCIsImNsZWFyVGltZW91dCIsIkNhbmNlbGxhdGlvbkVycm9yIiwibXVsdGlSZXNvbHZlIiwicm9vdHMiLCJhcmdzIiwicm9vdCIsInBhdGgiLCJzYWZlSnNvblBhcnNlIiwib2JqIiwiSlNPTiIsInBhcnNlIiwiaWduIiwianNvblN0cmluZ2lmeSIsInJlcGxhY2VyIiwic3BhY2UiLCJpc0Z1bmN0aW9uIiwiayIsInYiLCJidWZmZXJUb0pTT04iLCJCdWZmZXIiLCJwcm90b3R5cGUiLCJ0b0pTT04iLCJzdHJpbmdpZnkiLCJrZXkiLCJ1cGRhdGVkVmFsdWUiLCJpc0J1ZmZlciIsInRvU3RyaW5nIiwidW53cmFwRWxlbWVudCIsImVsIiwicHJvcE5hbWUiLCJoYXMiLCJ3cmFwRWxlbWVudCIsImVsZW1lbnRJZCIsIkVMRU1FTlQiLCJmaWx0ZXJPYmplY3QiLCJwcmVkaWNhdGUiLCJuZXdPYmoiLCJjbG9uZSIsInZhbHVlUHJlZGljYXRlIiwiT2JqZWN0Iiwia2V5cyIsInRvUmVhZGFibGVTaXplU3RyaW5nIiwiYnl0ZXMiLCJpbnRCeXRlcyIsInBhcnNlSW50IiwiRXJyb3IiLCJwYXJzZUZsb2F0IiwidG9GaXhlZCIsImlzU3ViUGF0aCIsIm9yaWdpbmFsUGF0aCIsImZvcmNlUG9zaXgiLCJwYXRoT2JqIiwicG9zaXgiLCJwIiwiaXNBYnNvbHV0ZSIsIm5vcm1hbGl6ZWRSb290Iiwibm9ybWFsaXplIiwibm9ybWFsaXplZFBhdGgiLCJzdGFydHNXaXRoIiwiaXNTYW1lRGVzdGluYXRpb24iLCJwYXRoMSIsInBhdGgyIiwicGF0aE4iLCJhbGxQYXRocyIsInJlZHVjZSIsImEiLCJiIiwiZnMiLCJleGlzdHMiLCJhcmVBbGxJdGVtc0VxdWFsIiwiYXJyIiwiTmFOIiwibWFwQ2IiLCJ4Iiwic3RhdCIsImJpZ2ludCIsImlubyIsInNlbXZlciIsImx0IiwicHJvY2VzcyIsInZlcnNpb24iLCJjb2VyY2VWZXJzaW9uIiwidmVyIiwic3RyaWN0IiwicmVzdWx0IiwidmFsaWQiLCJjb2VyY2UiLCJTVVBQT1JURURfT1BFUkFUT1JTIiwiY29tcGFyZVZlcnNpb25zIiwidmVyMSIsIm9wZXJhdG9yIiwidmVyMiIsImluY2x1ZGVzIiwic2VtdmVyT3BlcmF0b3IiLCJzYXRpc2ZpZXMiLCJxdW90ZSIsInVubGVha1N0cmluZyIsInMiLCJzdWJzdHIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLDBCQUEwQixHQUFHLHFDQUFuQzs7O0FBRU8sU0FBU0MsVUFBVCxDQUFxQkMsR0FBckIsRUFBMEI7QUFDL0IsU0FBT0MsZ0JBQUVDLFFBQUYsQ0FBV0YsR0FBWCxLQUFtQkEsR0FBRyxLQUFLLEVBQWxDO0FBQ0Q7O0FBR0QsU0FBU0csUUFBVCxDQUFtQkgsR0FBbkIsRUFBd0I7QUFDdEIsTUFBSUksTUFBTSxH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ekMsQ0FBTjtBQUVEOztBQUVELFFBQU1NLGNBQWMsR0FBRyxDQUFDLElBQUQsRUFBTyxJQUFQLEVBQWFELFFBQWIsQ0FBc0JGLFFBQXRCLElBQWtDLEdBQWxDLEdBQXdDQSxRQUEvRDs7QUFDQSxRQUFNTixNQUFNLEdBQUdQLGdCQUFPaUIsU0FBUCxDQUFpQmIsYUFBYSxDQUFDUSxJQUFELENBQTlCLEVBQXVDLEdBQUVJLGNBQWUsR0FBRVosYUFBYSxDQUFDVSxJQUFELENBQU8sRUFBOUUsQ0FBZjs7QUFDQSxTQUFPRCxRQUFRLEtBQUssSUFBYixHQUFvQixDQUFDTixNQUFyQixHQUE4QkEsTUFBckM7QUFDRDs7QUFTRCxTQUFTVyxLQUFULENBQWdCM0YsSUFBaEIsRUFBc0I7QUFDcEIsU0FBTyx1QkFBV0EsSUFBWCxDQUFQO0FBQ0Q7O0FBVUQsU0FBUzRGLFlBQVQsQ0FBdUJDLENBQXZCLEVBQTBCO0FBQ3hCLFNBQVEsSUFBR0EsQ0FBRSxFQUFOLENBQVFDLE1BQVIsQ0FBZSxDQUFmLENBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgb3MgZnJvbSAnb3MnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgZnMgZnJvbSAnLi9mcyc7XG5pbXBvcnQgc2VtdmVyIGZyb20gJ3NlbXZlcic7XG5pbXBvcnQgeyBxdW90ZSBhcyBzaGVsbFF1b3RlIH0gZnJvbSAnc2hlbGwtcXVvdGUnO1xuXG5cbmNvbnN0IFczQ19XRUJfRUxFTUVOVF9JREVOVElGSUVSID0gJ2VsZW1lbnQtNjA2Ni0xMWU0LWE1MmUtNGY3MzU0NjZjZWNmJztcblxuZXhwb3J0IGZ1bmN0aW9uIGhhc0NvbnRlbnQgKHZhbCkge1xuICByZXR1cm4gXy5pc1N0cmluZyh2YWwpICYmIHZhbCAhPT0gJyc7XG59XG5cbi8vIHJldHVybiB0cnVlIGlmIHRoZSB0aGUgdmFsdWUgaXMgbm90IHVuZGVmaW5lZCwgbnVsbCwgb3IgTmFOLlxuZnVuY3Rpb24gaGFzVmFsdWUgKHZhbCkge1xuICBsZXQgaGFzVmFsID0gZmFsc2U7XG4gIC8vIGF2b2lkIGluY29ycmVjdGx5IGV2YWx1YXRpbmcgYDBgIGFzIGZhbHNlXG4gIGlmIChfLmlzTnVtYmVyKHZhbCkpIHtcbiAgICBoYXNWYWwgPSAhXy5pc05hTih2YWwpO1xuICB9IGVsc2Uge1xuICAgIGhhc1ZhbCA9ICFfLmlzVW5kZWZpbmVkKHZhbCkgJiYgIV8uaXNOdWxsKHZhbCk7XG4gIH1cblxuICByZXR1cm4gaGFzVmFsO1xufVxuXG4vLyBlc2NhcGUgc3BhY2VzIGluIHN0cmluZywgZm9yIGNvbW1hbmRsaW5lIGNhbGxzXG5mdW5jdGlvbiBlc2NhcGVTcGFjZSAoc3RyKSB7XG4gIHJldHVybiBzdHIuc3BsaXQoLyAvKS5qb2luKCdcXFxcICcpO1xufVxuXG5mdW5jdGlvbiBlc2NhcGVTcGVjaWFsQ2hhcnMgKHN0ciwgcXVvdGVFc2NhcGUpIHtcbiAgaWYgKHR5cGVvZiBzdHIgIT09ICdzdHJpbmcnKSB7XG4gICAgcmV0dXJuIHN0cjtcbiAgfVxuICBpZiAodHlwZW9mIHF1b3RlRXNjYXBlID09PSAndW5kZWZpbmVkJykge1xuICAgIHF1b3RlRXNjYXBlID0gZmFsc2U7XG4gIH1cbiAgc3RyID0gc3RyXG4gICAgLnJlcGxhY2UoL1tcXFxcXS9nLCAnXFxcXFxcXFwnKVxuICAgIC5yZXBsYWNlKC9bXFwvXS9nLCAnXFxcXC8nKSAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVzZWxlc3MtZXNjYXBlXG4gICAgLnJlcGxhY2UoL1tcXGJdL2csICdcXFxcYicpXG4gICAgLnJlcGxhY2UoL1tcXGZdL2csICdcXFxcZicpXG4gICAgLnJlcGxhY2UoL1tcXG5dL2csICdcXFxcbicpXG4gICAgLnJlcGxhY2UoL1tcXHJdL2csICdcXFxccicpXG4gICAgLnJlcGxhY2UoL1tcXHRdL2csICdcXFxcdCcpXG4gICAgLnJlcGxhY2UoL1tcXFwiXS9nLCAnXFxcXFwiJykgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby11c2VsZXNzLWVzY2FwZVxuICAgIC5yZXBsYWNlKC9cXFxcJy9nLCBcIlxcXFwnXCIpO1xuICBpZiAocXVvdGVFc2NhcGUpIHtcbiAgICBsZXQgcmUgPSBuZXcgUmVnRXhwKHF1b3RlRXNjYXBlLCAnZycpO1xuICAgIHN0ciA9IHN0ci5yZXBsYWNlKHJlLCBgXFxcXCR7cXVvdGVFc2NhcGV9YCk7XG4gIH1cbiAgcmV0dXJuIHN0cjtcbn1cblxuZnVuY3Rpb24gbG9jYWxJcCAoKSB7XG4gIGxldCBpcCA9IF8uY2hhaW4ob3MubmV0d29ya0ludGVyZmFjZXMoKSlcbiAgICAudmFsdWVzKClcbiAgICAuZmxhdHRlbigpXG4gICAgLmZpbHRlcihmdW5jdGlvbiAodmFsKSB7XG4gICAgICByZXR1cm4gKHZhbC5mYW1pbHkgPT09ICdJUHY0JyAmJiB2YWwuaW50ZXJuYWwgPT09IGZhbHNlKTtcbiAgICB9KVxuICAgIC5tYXAoJ2FkZHJlc3MnKVxuICAgIC5maXJzdCgpXG4gICAgLnZhbHVlKCk7XG4gIHJldHVybiBpcDtcbn1cblxuLypcbiAqIENyZWF0ZXMgYSBwcm9taXNlIHRoYXQgaXMgY2FuY2VsbGFibGUsIGFuZCB3aWxsIHRpbWVvdXRcbiAqIGFmdGVyIGBtc2AgZGVsYXlcbiAqL1xuZnVuY3Rpb24gY2FuY2VsbGFibGVEZWxheSAobXMpIHtcbiAgbGV0IHRpbWVyO1xuICBsZXQgcmVzb2x2ZTtcbiAgbGV0IHJlamVjdDtcblxuICBjb25zdCBkZWxheSA9IG5ldyBCLlByb21pc2UoKF9yZXNvbHZlLCBfcmVqZWN0KSA9PiB7XG4gICAgcmVzb2x2ZSA9IF9yZXNvbHZlO1xuICAgIHJlamVjdCA9IF9yZWplY3Q7XG4gICAgdGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICAgIHJlc29sdmUoKTtcbiAgICB9LCBtcyk7XG4gIH0pO1xuXG4gIC8vIG92ZXJyaWRlIEJsdWViaXJkJ3MgYGNhbmNlbGAsIHdoaWNoIGRvZXMgbm90IHdvcmsgd2hlbiB1c2luZyBgYXdhaXRgIG9uXG4gIC8vIGEgcHJvbWlzZSwgc2luY2UgYHJlc29sdmVgL2ByZWplY3RgIGFyZSBuZXZlciBjYWxsZWRcbiAgZGVsYXkuY2FuY2VsID0gZnVuY3Rpb24gKCkge1xuICAgIGNsZWFyVGltZW91dCh0aW1lcik7XG4gICAgcmVqZWN0KG5ldyBCLkNhbmNlbGxhdGlvbkVycm9yKCkpO1xuICB9O1xuICByZXR1cm4gZGVsYXk7XG59XG5cbmZ1bmN0aW9uIG11bHRpUmVzb2x2ZSAocm9vdHMsIC4uLmFyZ3MpIHtcbiAgcmV0dXJuIHJvb3RzLm1hcCgocm9vdCkgPT4ge1xuICAgIHJldHVybiBwYXRoLnJlc29sdmUocm9vdCwgLi4uYXJncyk7XG4gIH0pO1xufVxuXG4vKlxuICogUGFyc2VzIGFuIG9iamVjdCBpZiBwb3NzaWJsZS4gT3RoZXJ3aXNlIHJldHVybnMgdGhlIG9iamVjdCB3aXRob3V0IHBhcnNpbmcuXG4gKi9cbmZ1bmN0aW9uIHNhZmVKc29uUGFyc2UgKG9iaikge1xuICB0cnkge1xuICAgIHJldHVybiBKU09OLnBhcnNlKG9iaik7XG4gIH0gY2F0Y2ggKGlnbikge1xuICAgIC8vIGlnbm9yZTogdGhpcyBpcyBub3QganNvbiBwYXJzYWJsZVxuICAgIHJldHVybiBvYmo7XG4gIH1cbn1cblxuLypcbiAqIFN0cmluZ2lmaWVzIHRoZSBvYmplY3QgcGFzc2VkIGluLCBjb252ZXJ0aW5nIEJ1ZmZlcnMgaW50byBTdHJpbmdzIGZvciBiZXR0ZXJcbiAqIGRpc3BsYXkuIFRoaXMgbWltaWNzIEpTT04uc3RyaW5naWZ5IChzZWUgaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvSlNPTi9zdHJpbmdpZnkpXG4gKiBleGNlcHQgdGhlIGByZXBsYWNlcmAgYXJndW1lbnQgY2FuIG9ubHkgYmUgYSBmdW5jdGlvbi5cbiAqXG4gKiBAcGFyYW0ge29iamVjdH0gb2JqIC0gdGhlIG9iamVjdCB0byBiZSBzZXJpYWxpemVkXG4gKiBAcGFyYW0gez9mdW5jdGlvbn0gcmVwbGFjZXIgLSBmdW5jdGlvbiB0byB0cmFuc2Zvcm0gdGhlIHByb3BlcnRpZXMgYWRkZWQgdG8gdGhlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZXJpYWxpemVkIG9iamVjdFxuICogQHBhcmFtIHs/bnVtYmVyfHN0cmluZ30gc3BhY2UgLSB1c2VkIHRvIGluc2VydCB3aGl0ZSBzcGFjZSBpbnRvIHRoZSBvdXRwdXQgSlNPTlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmcgZm9yIHJlYWRhYmlsaXR5IHB1cnBvc2VzLiBEZWZhdWx0cyB0byAyXG4gKiByZXR1cm5zIHtzdHJpbmd9IC0gdGhlIEpTT04gb2JqZWN0IHNlcmlhbGl6ZWQgYXMgYSBzdHJpbmdcbiAqL1xuZnVuY3Rpb24ganNvblN0cmluZ2lmeSAob2JqLCByZXBsYWNlciwgc3BhY2UgPSAyKSB7XG4gIC8vIGlmIG5vIHJlcGxhY2VyIGlzIHBhc3NlZCwgb3IgaXQgaXMgbm90IGEgZnVuY3Rpb24sIGp1c3QgdXNlIGEgcGFzcy10aHJvdWdoXG4gIGlmICghXy5pc0Z1bmN0aW9uKHJlcGxhY2VyKSkge1xuICAgIHJlcGxhY2VyID0gKGssIHYpID0+IHY7XG4gIH1cblxuICAvLyBCdWZmZXJzIGNhbm5vdCBiZSBzZXJpYWxpemVkIGluIGEgcmVhZGFibGUgd2F5XG4gIGNvbnN0IGJ1ZmZlclRvSlNPTiA9IEJ1ZmZlci5wcm90b3R5cGUudG9KU09OO1xuICBkZWxldGUgQnVmZmVyLnByb3RvdHlwZS50b0pTT047XG4gIHRyeSB7XG4gICAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KG9iaiwgKGtleSwgdmFsdWUpID0+IHtcbiAgICAgIGNvbnN0IHVwZGF0ZWRWYWx1ZSA9IEJ1ZmZlci5pc0J1ZmZlcih2YWx1ZSlcbiAgICAgICAgPyB2YWx1ZS50b1N0cmluZygndXRmOCcpXG4gICAgICAgIDogdmFsdWU7XG4gICAgICByZXR1cm4gcmVwbGFjZXIoa2V5LCB1cGRhdGVkVmFsdWUpO1xuICAgIH0sIHNwYWNlKTtcbiAgfSBmaW5hbGx5IHtcbiAgICAvLyByZXN0b3JlIHRoZSBmdW5jdGlvbiwgc28gYXMgdG8gbm90IGJyZWFrIGZ1cnRoZXIgc2VyaWFsaXphdGlvblxuICAgIEJ1ZmZlci5wcm90b3R5cGUudG9KU09OID0gYnVmZmVyVG9KU09OO1xuICB9XG59XG5cbi8qXG4gKiBSZW1vdmVzIHRoZSB3cmFwcGVyIGZyb20gZWxlbWVudCwgaWYgaXQgZXhpc3RzLlxuICogICB7IEVMRU1FTlQ6IDQgfSBiZWNvbWVzIDRcbiAqICAgeyBlbGVtZW50LTYwNjYtMTFlNC1hNTJlLTRmNzM1NDY2Y2VjZjogNSB9IGJlY29tZXMgNVxuICovXG5mdW5jdGlvbiB1bndyYXBFbGVtZW50IChlbCkge1xuICBmb3IgKGNvbnN0IHByb3BOYW1lIG9mIFtXM0NfV0VCX0VMRU1FTlRfSURFTlRJRklFUiwgJ0VMRU1FTlQnXSkge1xuICAgIGlmIChfLmhhcyhlbCwgcHJvcE5hbWUpKSB7XG4gICAgICByZXR1cm4gZWxbcHJvcE5hbWVdO1xuICAgIH1cbiAgfVxuICByZXR1cm4gZWw7XG59XG5cbmZ1bmN0aW9uIHdyYXBFbGVtZW50IChlbGVtZW50SWQpIHtcbiAgcmV0dXJuIHtcbiAgICBFTEVNRU5UOiBlbGVtZW50SWQsXG4gICAgW1czQ19XRUJfRUxFTUVOVF9JREVOVElGSUVSXTogZWxlbWVudElkLFxuICB9O1xufVxuXG4vKlxuICogUmV0dXJucyBvYmplY3QgY29uc2lzdGluZyBvZiBhbGwgcHJvcGVydGllcyBpbiB0aGUgb3JpZ2luYWwgZWxlbWVudFxuICogd2hpY2ggd2VyZSB0cnV0aHkgZ2l2ZW4gdGhlIHByZWRpY2F0ZS5cbiAqIElmIHRoZSBwcmVkaWNhdGUgaXNcbiAqICAgKiBtaXNzaW5nIC0gaXQgd2lsbCByZW1vdmUgYWxsIHByb3BlcnRpZXMgd2hvc2UgdmFsdWVzIGFyZSBgdW5kZWZpbmVkYFxuICogICAqIGEgc2NhbGFyIC0gaXQgd2lsbCB0ZXN0IGFsbCBwcm9wZXJ0aWVzJyB2YWx1ZXMgYWdhaW5zdCB0aGF0IHZhbHVlXG4gKiAgICogYSBmdW5jdGlvbiAtIGl0IHdpbGwgcGFzcyBlYWNoIHZhbHVlIGFuZCB0aGUgb3JpZ2luYWwgb2JqZWN0IGludG8gdGhlIGZ1bmN0aW9uXG4gKi9cbmZ1bmN0aW9uIGZpbHRlck9iamVjdCAob2JqLCBwcmVkaWNhdGUpIHtcbiAgbGV0IG5ld09iaiA9IF8uY2xvbmUob2JqKTtcbiAgaWYgKF8uaXNVbmRlZmluZWQocHJlZGljYXRlKSkge1xuICAgIC8vIHJlbW92ZSBhbnkgZWxlbWVudCBmcm9tIHRoZSBvYmplY3Qgd2hvc2UgdmFsdWUgaXMgdW5kZWZpbmVkXG4gICAgcHJlZGljYXRlID0gKHYpID0+ICFfLmlzVW5kZWZpbmVkKHYpO1xuICB9IGVsc2UgaWYgKCFfLmlzRnVuY3Rpb24ocHJlZGljYXRlKSkge1xuICAgIC8vIG1ha2UgcHJlZGljYXRlIGludG8gYSBmdW5jdGlvblxuICAgIGNvbnN0IHZhbHVlUHJlZGljYXRlID0gcHJlZGljYXRlO1xuICAgIHByZWRpY2F0ZSA9ICh2KSA9PiB2ID09PSB2YWx1ZVByZWRpY2F0ZTtcbiAgfVxuICBmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhvYmopKSB7XG4gICAgaWYgKCFwcmVkaWNhdGUob2JqW2tleV0sIG9iaikpIHtcbiAgICAgIGRlbGV0ZSBuZXdPYmpba2V5XTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIG5ld09iajtcbn1cblxuLyoqXG4gKiBDb252ZXJ0cyBudW1iZXIgb2YgYnl0ZXMgdG8gYSByZWFkYWJsZSBzaXplIHN0cmluZy5cbiAqXG4gKiBAcGFyYW0ge251bWJlcnxzdHJpbmd9IGJ5dGVzIC0gVGhlIGFjdHVhbCBudW1iZXIgb2YgYnl0ZXMuXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBUaGUgYWN0dWFsIHN0cmluZyByZXByZXNlbnRhdGlvbiwgZm9yIGV4YW1wbGVcbiAqICAgICAgICAgICAgICAgICAgICcxLjAwIEtCJyBmb3IgJzEwMjQgQidcbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBieXRlcyBjb3VudCBjYW5ub3QgYmUgY29udmVydGVkIHRvIGFuIGludGVnZXIgb3JcbiAqICAgICAgICAgICAgICAgICBpZiBpdCBpcyBsZXNzIHRoYW4gemVyby5cbiAqL1xuZnVuY3Rpb24gdG9SZWFkYWJsZVNpemVTdHJpbmcgKGJ5dGVzKSB7XG4gIGNvbnN0IGludEJ5dGVzID0gcGFyc2VJbnQoYnl0ZXMsIDEwKTtcbiAgaWYgKGlzTmFOKGludEJ5dGVzKSB8fCBpbnRCeXRlcyA8IDApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBjb252ZXJ0ICcke2J5dGVzfScgdG8gYSByZWFkYWJsZSBzaXplIGZvcm1hdGApO1xuICB9XG4gIGlmIChpbnRCeXRlcyA+PSAxMDI0ICogMTAyNCAqIDEwMjQpIHtcbiAgICByZXR1cm4gYCR7cGFyc2VGbG9hdChpbnRCeXRlcyAvICgxMDI0ICogMTAyNCAqIDEwMjQuMCkpLnRvRml4ZWQoMil9IEdCYDtcbiAgfSBlbHNlIGlmIChpbnRCeXRlcyA+PSAxMDI0ICogMTAyNCkge1xuICAgIHJldHVybiBgJHtwYXJzZUZsb2F0KGludEJ5dGVzIC8gKDEwMjQgKiAxMDI0LjApKS50b0ZpeGVkKDIpfSBNQmA7XG4gIH0gZWxzZSBpZiAoaW50Qnl0ZXMgPj0gMTAyNCkge1xuICAgIHJldHVybiBgJHtwYXJzZUZsb2F0KGludEJ5dGVzIC8gMTAyNC4wKS50b0ZpeGVkKDIpfSBLQmA7XG4gIH1cbiAgcmV0dXJuIGAke2ludEJ5dGVzfSBCYDtcbn1cblxuLyoqXG4gKiBDaGVja3Mgd2hldGhlciB0aGUgZ2l2ZW4gcGF0aCBpcyBhIHN1YnBhdGggb2YgdGhlXG4gKiBwYXJ0aWN1bGFyIHJvb3QgZm9sZGVyLiBCb3RoIHBhdGhzIGNhbiBpbmNsdWRlIC4uIGFuZCAuIHNwZWNpZmllcnNcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gb3JpZ2luYWxQYXRoIFRoZSBhYnNvbHV0ZSBmaWxlL2ZvbGRlciBwYXRoXG4gKiBAcGFyYW0ge3N0cmluZ30gcm9vdCBUaGUgYWJzb2x1dGUgcm9vdCBmb2xkZXIgcGF0aFxuICogQHBhcmFtIHs/Ym9vbGVhbn0gZm9yY2VQb3NpeCBTZXQgaXQgdG8gdHJ1ZSBpZiBwYXRocyBtdXN0IGJlIGludGVycHJldGVkIGluIFBPU0lYIGZvcm1hdFxuICogQHJldHVybnMge2Jvb2xlYW59IHRydWUgaWYgdGhlIGdpdmVuIG9yaWdpbmFsIHBhdGggaXMgdGhlIHN1YnBhdGggb2YgdGhlIHJvb3QgZm9sZGVyXG4gKiBAdGhyb3dzIHtFcnJvcn0gaWYgYW55IG9mIHRoZSBnaXZlbiBwYXRocyBpcyBub3QgYWJzb2x1dGVcbiAqL1xuZnVuY3Rpb24gaXNTdWJQYXRoIChvcmlnaW5hbFBhdGgsIHJvb3QsIGZvcmNlUG9zaXggPSBudWxsKSB7XG4gIGNvbnN0IHBhdGhPYmogPSBmb3JjZVBvc2l4ID8gcGF0aC5wb3NpeCA6IHBhdGg7XG4gIGZvciAoY29uc3QgcCBvZiBbb3JpZ2luYWxQYXRoLCByb290XSkge1xuICAgIGlmICghcGF0aE9iai5pc0Fic29sdXRlKHApKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYCcke3B9JyBpcyBleHBlY3RlZCB0byBiZSBhbiBhYnNvbHV0ZSBwYXRoYCk7XG4gICAgfVxuICB9XG4gIGNvbnN0IG5vcm1hbGl6ZWRSb290ID0gcGF0aE9iai5ub3JtYWxpemUocm9vdCk7XG4gIGNvbnN0IG5vcm1hbGl6ZWRQYXRoID0gcGF0aE9iai5ub3JtYWxpemUob3JpZ2luYWxQYXRoKTtcbiAgcmV0dXJuIG5vcm1hbGl6ZWRQYXRoLnN0YXJ0c1dpdGgobm9ybWFsaXplZFJvb3QpO1xufVxuXG4vKipcbiAqIENoZWNrcyB3aGV0aGVyIHRoZSBnaXZlbiBwYXRocyBhcmUgcG9pbnRpbmcgdG8gdGhlIHNhbWUgZmlsZSBzeXN0ZW1cbiAqIGRlc3RpbmF0aW9uLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBwYXRoMSAtIEFic29sdXRlIG9yIHJlbGF0aXZlIHBhdGggdG8gYSBmaWxlL2ZvbGRlclxuICogQHBhcmFtIHtzdHJpbmd9IHBhdGgyIC0gQWJzb2x1dGUgb3IgcmVsYXRpdmUgcGF0aCB0byBhIGZpbGUvZm9sZGVyXG4gKiBAcGFyYW0gey4uLnN0cmluZ30gcGF0aE4gLSBaZXJvIG9yIG1vcmUgYWJzb2x1dGUgb3IgcmVsYXRpdmUgcGF0aHMgdG8gZmlsZXMvZm9sZGVyc1xuICogQHJldHVybnMge2Jvb2xlYW59IHRydWUgaWYgYWxsIHBhdGhzIGFyZSBwb2ludGluZyB0byB0aGUgc2FtZSBmaWxlIHN5c3RlbSBpdGVtXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGlzU2FtZURlc3RpbmF0aW9uIChwYXRoMSwgcGF0aDIsIC4uLnBhdGhOKSB7XG4gIGNvbnN0IGFsbFBhdGhzID0gW3BhdGgxLCBwYXRoMiwgLi4ucGF0aE5dO1xuICBpZiAoIWF3YWl0IEIucmVkdWNlKGFsbFBhdGhzLCBhc3luYyAoYSwgYikgPT4gYSAmJiBhd2FpdCBmcy5leGlzdHMoYiksIHRydWUpKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgY29uc3QgYXJlQWxsSXRlbXNFcXVhbCA9IChhcnIpID0+ICEhYXJyLnJlZHVjZSgoYSwgYikgPT4gYSA9PT0gYiA/IGEgOiBOYU4pO1xuICBpZiAoYXJlQWxsSXRlbXNFcXVhbChhbGxQYXRocykpIHtcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8vIE5vZGUgMTAuNS4wIGludHJvZHVjZWQgYmlnaW50IHN1cHBvcnQgaW4gc3RhdCwgd2hpY2ggYWxsb3dzIGZvciBtb3JlIHByZWNpc2lvblxuICAvLyBob3dldmVyIGJlbG93IHRoYXQgdGhlIG9wdGlvbnMgZ2V0IGludGVycHJldGVkIGFzIHRoZSBjYWxsYmFja1xuICAvLyBUT0RPOiByZW1vdmUgd2hlbiBOb2RlIDEwIGlzIG5vIGxvbmdlciBzdXBwb3J0ZWRcbiAgbGV0IG1hcENiID0gYXN5bmMgKHgpID0+IGF3YWl0IGZzLnN0YXQoeCwge1xuICAgIGJpZ2ludDogdHJ1ZSxcbiAgfSkuaW5vO1xuICBpZiAoc2VtdmVyLmx0KHByb2Nlc3MudmVyc2lvbiwgJzEwLjUuMCcpKSB7XG4gICAgbWFwQ2IgPSBhc3luYyAoeCkgPT4gYXdhaXQgZnMuc3RhdCh4KS5pbm87XG4gIH1cbiAgcmV0dXJuIGFyZUFsbEl0ZW1zRXF1YWwoYXdhaXQgQi5tYXAoYWxsUGF0aHMsIG1hcENiKSk7XG59XG5cbi8qKlxuICogQ29lcmNlcyB0aGUgZ2l2ZW4gbnVtYmVyL3N0cmluZyB0byBhIHZhbGlkIHZlcnNpb24gc3RyaW5nXG4gKlxuICogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSB2ZXIgLSBWZXJzaW9uIHN0cmluZyB0byBjb2VyY2VcbiAqIEBwYXJhbSB7Ym9vbGVhbn0gc3RyaWN0IFt0cnVlXSAtIElmIHRydWUgdGhlbiBhbiBleGNlcHRpb24gd2lsbCBiZSB0aHJvd25cbiAqIGlmIGB2ZXJgIGNhbm5vdCBiZSBjb2VyY2VkXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBDb2VyY2VkIHZlcnNpb24gbnVtYmVyIG9yIG51bGwgaWYgdGhlIHN0cmluZyBjYW5ub3QgYmVcbiAqIGNvZXJjZWQgYW5kIHN0cmljdCBtb2RlIGlzIGRpc2FibGVkXG4gKiBAdGhyb3dzIHtFcnJvcn0gaWYgc3RyaWN0IG1vZGUgaXMgZW5hYmxlZCBhbmQgYHZlcmAgY2Fubm90IGJlIGNvZXJjZWRcbiAqL1xuZnVuY3Rpb24gY29lcmNlVmVyc2lvbiAodmVyLCBzdHJpY3QgPSB0cnVlKSB7XG4gIGNvbnN0IHJlc3VsdCA9IHNlbXZlci52YWxpZChzZW12ZXIuY29lcmNlKGAke3Zlcn1gKSk7XG4gIGlmIChzdHJpY3QgJiYgIXJlc3VsdCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgJyR7dmVyfScgY2Fubm90IGJlIGNvZXJjZWQgdG8gYSB2YWxpZCB2ZXJzaW9uIG51bWJlcmApO1xuICB9XG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmNvbnN0IFNVUFBPUlRFRF9PUEVSQVRPUlMgPSBbJz09JywgJyE9JywgJz4nLCAnPCcsICc+PScsICc8PScsICc9J107XG5cbi8qKlxuICogQ29tcGFyZXMgdHdvIHZlcnNpb24gc3RyaW5nc1xuICpcbiAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gdmVyMSAtIFRoZSBmaXJzdCB2ZXJzaW9uIG51bWJlciB0byBjb21wYXJlLiBTaG91bGQgYmUgYSB2YWxpZFxuICogdmVyc2lvbiBudW1iZXIgc3VwcG9ydGVkIGJ5IHNlbXZlciBwYXJzZXIuXG4gKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IHZlcjIgLSBUaGUgc2Vjb25kIHZlcnNpb24gbnVtYmVyIHRvIGNvbXBhcmUuIFNob3VsZCBiZSBhIHZhbGlkXG4gKiB2ZXJzaW9uIG51bWJlciBzdXBwb3J0ZWQgYnkgc2VtdmVyIHBhcnNlci5cbiAqIEBwYXJhbSB7c3RyaW5nfSBvcGVyYXRvciAtIE9uZSBvZiBzdXBwb3J0ZWQgdmVyc2lvbiBudW1iZXIgb3BlcmF0b3JzOlxuICogPT0sICE9LCA+LCA8LCA8PSwgPj0sID1cbiAqIEByZXR1cm5zIHtib29sZWFufSB0cnVlIG9yIGZhbHNlIGRlcGVuZGluZyBvbiB0aGUgYWN0dWFsIGNvbXBhcmlzb24gcmVzdWx0XG4gKiBAdGhyb3dzIHtFcnJvcn0gaWYgYW4gdW5zdXBwb3J0ZWQgb3BlcmF0b3IgaXMgc3VwcGxpZWQgb3IgYW55IG9mIHRoZSBzdXBwbGllZFxuICogdmVyc2lvbiBzdHJpbmdzIGNhbm5vdCBiZSBjb2VyY2VkXG4gKi9cbmZ1bmN0aW9uIGNvbXBhcmVWZXJzaW9ucyAodmVyMSwgb3BlcmF0b3IsIHZlcjIpIHtcbiAgaWYgKCFTVVBQT1JURURfT1BFUkFUT1JTLmluY2x1ZGVzKG9wZXJhdG9yKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgVGhlICcke29wZXJhdG9yfScgY29tcGFyaXNvbiBvcGVyYXRvciBpcyBub3Qgc3VwcG9ydGVkLiBgICtcbiAgICAgIGBPbmx5ICcke0pTT04uc3RyaW5naWZ5KFNVUFBPUlRFRF9PUEVSQVRPUlMpfScgb3BlcmF0b3JzIGFyZSBzdXBwb3J0ZWRgKTtcbiAgfVxuXG4gIGNvbnN0IHNlbXZlck9wZXJhdG9yID0gWyc9PScsICchPSddLmluY2x1ZGVzKG9wZXJhdG9yKSA/ICc9JyA6IG9wZXJhdG9yO1xuICBjb25zdCByZXN1bHQgPSBzZW12ZXIuc2F0aXNmaWVzKGNvZXJjZVZlcnNpb24odmVyMSksIGAke3NlbXZlck9wZXJhdG9yfSR7Y29lcmNlVmVyc2lvbih2ZXIyKX1gKTtcbiAgcmV0dXJuIG9wZXJhdG9yID09PSAnIT0nID8gIXJlc3VsdCA6IHJlc3VsdDtcbn1cblxuLyoqXG4gKiBBZGQgYXBwcm9wcmlhdGUgcXVvdGVzIHRvIGNvbW1hbmQgYXJndW1lbnRzLiBTZWUgaHR0cHM6Ly9naXRodWIuY29tL3N1YnN0YWNrL25vZGUtc2hlbGwtcXVvdGVcbiAqIGZvciBtb3JlIGRldGFpbHNcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ3xBcnJheTxzdHJpbmc+fSAtIFRoZSBhcmd1bWVudHMgdGhhdCB3aWxsIGJlIHBhcnNlZFxuICogQHJldHVybnMge3N0cmluZ30gLSBUaGUgYXJndW1lbnRzLCBxdW90ZWRcbiAqL1xuZnVuY3Rpb24gcXVvdGUgKGFyZ3MpIHtcbiAgcmV0dXJuIHNoZWxsUXVvdGUoYXJncyk7XG59XG5cbi8qKlxuICogVGhpcyBmdW5jdGlvbiBpcyBuZWNlc3NhcnkgdG8gd29ya2Fyb3VuZCB1bmV4cGVjdGVkIG1lbW9yeSBsZWFrc1xuICogY2F1c2VkIGJ5IE5vZGVKUyBzdHJpbmcgaW50ZXJuaW5nXG4gKiBiZWhhdmlvciBkZXNjcmliZWQgaW4gaHR0cHM6Ly9idWdzLmNocm9taXVtLm9yZy9wL3Y4L2lzc3Vlcy9kZXRhaWw/aWQ9Mjg2OVxuICpcbiAqIEBwYXJhbSB7Kn0gcyAtIFRoZSBzdHJpbmcgdG8gdW5sZWFrXG4gKiBAcmV0dXJuIHtzdHJpbmd9IEVpdGhlciB0aGUgdW5sZWFrZWQgc3RyaW5nIG9yIHRoZSBvcmlnaW5hbCBvYmplY3QgY29udmVydGVkIHRvIHN0cmluZ1xuICovXG5mdW5jdGlvbiB1bmxlYWtTdHJpbmcgKHMpIHtcbiAgcmV0dXJuIGAgJHtzfWAuc3Vic3RyKDEpO1xufVxuXG5leHBvcnQge1xuICBoYXNWYWx1ZSwgZXNjYXBlU3BhY2UsIGVzY2FwZVNwZWNpYWxDaGFycywgbG9jYWxJcCwgY2FuY2VsbGFibGVEZWxheSxcbiAgbXVsdGlSZXNvbHZlLCBzYWZlSnNvblBhcnNlLCB3cmFwRWxlbWVudCwgdW53cmFwRWxlbWVudCwgZmlsdGVyT2JqZWN0LFxuICB0b1JlYWRhYmxlU2l6ZVN0cmluZywgaXNTdWJQYXRoLCBXM0NfV0VCX0VMRU1FTlRfSURFTlRJRklFUixcbiAgaXNTYW1lRGVzdGluYXRpb24sIGNvbXBhcmVWZXJzaW9ucywgY29lcmNlVmVyc2lvbiwgcXVvdGUsIHVubGVha1N0cmluZyxcbiAganNvblN0cmluZ2lmeSxcbn07XG4iXSwiZmlsZSI6ImxpYi91dGlsLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
