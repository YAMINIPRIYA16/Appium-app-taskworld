"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.configureApp = configureApp;
exports.isPackageOrBundle = isPackageOrBundle;
exports.getCoordDefault = getCoordDefault;
exports.getSwipeTouchDuration = getSwipeTouchDuration;
exports.duplicateKeys = duplicateKeys;
exports.parseCapsArray = parseCapsArray;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _url = _interopRequireDefault(require("url"));

var _logger = _interopRequireDefault(require("./logger"));

var _fs2 = _interopRequireDefault(require("fs"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumSupport = require("appium-support");

var _request = _interopRequireDefault(require("request"));

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _lruCache = _interopRequireDefault(require("lru-cache"));

var _asyncLock = _interopRequireDefault(require("async-lock"));

var _sanitizeFilename = _interopRequireDefault(require("sanitize-filename"));

const ZIP_EXTS = ['.zip', '.ipa'];
const ZIP_MIME_TYPES = ['application/zip', 'application/x-zip-compressed', 'multipart/x-zip'];
const CACHED_APPS_MAX_AGE = 1000 * 60 * 60 * 24;
const APPLICATIONS_CACHE = new _lruCache.default({
  maxAge: CACHED_APPS_MAX_AGE,
  updateAgeOnGet: true,
  dispose: async (app, {
    fullPath
  }) => {
    if (!(await _appiumSupport.fs.exists(fullPath))) {
      return;
    }

    _logger.default.info(`The application '${app}' cached at '${fullPath}' has expired`);

    await _appiumSupport.fs.rimraf(fullPath);
  },
  noDisposeOnSet: true
});
const APPLICATIONS_CACHE_GUARD = new _asyncLock.default();
const SANITIZE_REPLACEMENT = '-';
const DEFAULT_BASENAME = 'appium-app';
process.on('exit', () => {
  if (!APPLICATIONS_CACHE.length) {
    return;
  }

  const appPaths = APPLICATIONS_CACHE.values().map(({
    fullPath
  }) => fullPath);

  _logger.default.debug(`Performing cleanup of ${appPaths.length} cached ` + `application${appPaths.length === 1 ? '' : 's'}`);

  for (const appPath of appPaths) {
    try {
      _appiumSupport.fs.rimrafSync(appPath);
    } catch (e) {
      _logger.default.warn(e.message);
    }
  }
});

async function retrieveHeaders(link) {
  try {
    const response = await (0, _requestPromise.default)({
      url: link,
      method: 'HEAD',
      resolveWithFullResponse: true,
      timeout: 5000
    });
    return response.headers;
  } catch (e) {
    _logger.default.debug(`Cannot send HEAD request to '${link}'. Original error: ${e.message}`);
  }

  return {};
}

function getCachedApplicationPath(link, currentModified) {
  if (!APPLICATIONS_CACHE.has(link) || !currentModified) {
    return null;
  }

  const {
    lastModified,
    fullPath
  } = APPLICATIONS_CACHE.get(link);

  if (lastModified && currentModified.getTime() <= lastModified.getTime()) {
    return fullPath;
  }

  _logger.default.debug(`'Last-Modified' timestamp of '${link}' has been updated. ` + `A fresh copy of the application is going to be downloaded.`);

  return null;
}

function verifyAppExtension(app, supportedAppExtensions) {
  if (supportedAppExtensions.includes(_path.default.extname(app))) {
    return app;
  }

  throw new Error(`New app path '${app}' did not have extension(s) '${supportedAppExtensions}'`);
}

async function configureApp(app, supportedAppExtensions) {
  if (!_lodash.default.isString(app)) {
    return;
  }

  if (!_lodash.default.isArray(supportedAppExtensions)) {
    supportedAppExtensions = [supportedAppExtensions];
  }

  let newApp = app;
  let shouldUnzipApp = false;
  let archiveHash = null;
  let currentModified = null;

  const {
    protocol,
    pathname
  } = _url.default.parse(newApp);

  const isUrl = ['http:', 'https:'].includes(protocol);
  return await APPLICATIONS_CACHE_GUARD.acquire(app, async () => {
    if (isUrl) {
      _logger.default.info(`Using downloadable app '${newApp}'`);

      const headers = await retrieveHeaders(newApp);

      if (headers['last-modified']) {
        _logger.default.debug(`App Last-Modified: ${headers['last-modified']}`);

        currentModified = new Date(headers['last-modified']);
      }

      const cachedPath = getCachedApplicationPath(app, currentModified);

      if (cachedPath) {
        if (await _appiumSupport.fs.exists(cachedPath)) {
          _logger.default.info(`Reusing previously downloaded application at '${cachedPath}'`);

          return verifyAppExtension(cachedPath, supportedAppExtensions);
        }

        _logger.default.info(`The application at '${cachedPath}' does not exist anymore. Deleting it from the cache`);

        APPLICATIONS_CACHE.del(app);
      }

      let fileName = null;
      const basename = (0, _sanitizeFilename.default)(_path.default.basename(decodeURIComponent(pathname)), {
        replacement: SANITIZE_REPLACEMENT
      });

      const extname = _path.default.extname(basename);

      if (ZIP_EXTS.includes(extname)) {
        fileName = basename;
        shouldUnzipApp = true;
      }

      if (headers['content-type']) {
        _logger.default.debug(`Content-Type: ${headers['content-type']}`);

        if (ZIP_MIME_TYPES.some(mimeType => new RegExp(`\\b${_lodash.default.escapeRegExp(mimeType)}\\b`).test(headers['content-type']))) {
          if (!fileName) {
            fileName = `${DEFAULT_BASENAME}.zip`;
          }

          shouldUnzipApp = true;
        }
      }

      if (headers['content-disposition'] && /^attachment/i.test(headers['content-disposition'])) {
        _logger.default.debug(`Content-Disposition: ${headers['content-disposition']}`);

        const match = /filename="([^"]+)/i.exec(headers['content-disposition']);

        if (match) {
          fileName = (0, _sanitizeFilename.default)(match[1], {
            replacement: SANITIZE_REPLACEMENT
          });
          shouldUnzipApp = shouldUnzipApp || ZIP_EXTS.includes(_path.default.extname(fileName));
        }
      }

      if (!fileName) {
        const resultingName = basename ? basename.substring(0, basename.length - extname.length) : DEFAULT_BASENAME;
        let resultingExt = extname;

        if (!supportedAppExtensions.includes(resultingExt)) {
          _logger.default.info(`The current file extension '${resultingExt}' is not supported. ` + `Defaulting to '${_lodash.default.first(supportedAppExtensions)}'`);

          resultingExt = _lodash.default.first(supportedAppExtensions);
        }

        fileName = `${resultingName}${resultingExt}`;
      }

      const targetPath = await _appiumSupport.tempDir.path({
        prefix: fileName,
        suffix: ''
      });
      newApp = await downloadApp(newApp, targetPath);
    } else if (await _appiumSupport.fs.exists(newApp)) {
      _logger.default.info(`Using local app '${newApp}'`);

      shouldUnzipApp = ZIP_EXTS.includes(_path.default.extname(newApp));
    } else {
      let errorMessage = `The application at '${newApp}' does not exist or is not accessible`;

      if (_lodash.default.isString(protocol) && protocol.length > 2) {
        errorMessage = `The protocol '${protocol}' used in '${newApp}' is not supported. ` + `Only http: and https: protocols are supported`;
      }

      throw new Error(errorMessage);
    }

    if (shouldUnzipApp) {
      const archivePath = newApp;
      archiveHash = await _appiumSupport.fs.hash(archivePath);

      if (APPLICATIONS_CACHE.has(app) && archiveHash === APPLICATIONS_CACHE.get(app).hash) {
        const {
          fullPath
        } = APPLICATIONS_CACHE.get(app);

        if (await _appiumSupport.fs.exists(fullPath)) {
          if (archivePath !== app) {
            await _appiumSupport.fs.rimraf(archivePath);
          }

          _logger.default.info(`Will reuse previously cached application at '${fullPath}'`);

          return verifyAppExtension(fullPath, supportedAppExtensions);
        }

        _logger.default.info(`The application at '${fullPath}' does not exist anymore. Deleting it from the cache`);

        APPLICATIONS_CACHE.del(app);
      }

      const tmpRoot = await _appiumSupport.tempDir.openDir();

      try {
        newApp = await unzipApp(archivePath, tmpRoot, supportedAppExtensions);
      } finally {
        if (newApp !== archivePath && archivePath !== app) {
          await _appiumSupport.fs.rimraf(archivePath);
        }
      }

      _logger.default.info(`Unzipped local app to '${newApp}'`);
    } else if (!_path.default.isAbsolute(newApp)) {
      newApp = _path.default.resolve(process.cwd(), newApp);

      _logger.default.warn(`The current application path '${app}' is not absolute ` + `and has been rewritten to '${newApp}'. Consider using absolute paths rather than relative`);

      app = newApp;
    }

    verifyAppExtension(newApp, supportedAppExtensions);

    if (app !== newApp && (archiveHash || currentModified)) {
      if (APPLICATIONS_CACHE.has(app)) {
        const {
          fullPath
        } = APPLICATIONS_CACHE.get(app);

        if (fullPath !== newApp && (await _appiumSupport.fs.exists(fullPath))) {
          await _appiumSupport.fs.rimraf(fullPath);
        }
      }

      APPLICATIONS_CACHE.set(app, {
        hash: archiveHash,
        lastModified: currentModified,
        fullPath: newApp
      });
    }

    return newApp;
  });
}

async function downloadApp(app, targetPath) {
  const {
    href
  } = _url.default.parse(app);

  const timer = new _appiumSupport.timing.Timer().start();

  try {
    await new _bluebird.default((resolve, reject) => {
      (0, _request.default)(href).on('error', reject).on('response', res => {
        if (res.statusCode >= 400) {
          return reject(new Error(`${res.statusCode} - ${res.statusMessage}`));
        }
      }).pipe(_fs2.default.createWriteStream(targetPath)).on('close', resolve);
    });
  } catch (err) {
    throw new Error(`Problem downloading app from url ${href}: ${err.message}`);
  }

  const secondsElapsed = timer.getDuration().asSeconds;
  const {
    size
  } = await _appiumSupport.fs.stat(targetPath);

  _logger.default.debug(`'${href}' (${_appiumSupport.util.toReadableSizeString(size)}) ` + `has been downloaded to '${targetPath}' in ${secondsElapsed.toFixed(3)}s`);

  if (secondsElapsed >= 2) {
    const bytesPerSec = Math.floor(size / secondsElapsed);

    _logger.default.debug(`Approximate download speed: ${_appiumSupport.util.toReadableSizeString(bytesPerSec)}/s`);
  }

  return targetPath;
}

async function unzipApp(zipPath, dstRoot, supportedAppExtensions) {
  await _appiumSupport.zip.assertValidZip(zipPath);

  if (!_lodash.default.isArray(supportedAppExtensions)) {
    supportedAppExtensions = [supportedAppExtensions];
  }

  const tmpRoot = await _appiumSupport.tempDir.openDir();

  try {
    _logger.default.debug(`Unzipping '${zipPath}'`);

    await _appiumSupport.zip.extractAllTo(zipPath, tmpRoot);
    const allExtractedItems = [];
    await _appiumSupport.fs.walkDir(tmpRoot, true, itemPath => void allExtractedItems.push(itemPath));

    _logger.default.debug(`Extracted ${allExtractedItems.length} item(s) from '${zipPath}'`);

    const isSupportedAppItem = relativePath => supportedAppExtensions.includes(_path.default.extname(relativePath)) || _lodash.default.some(supportedAppExtensions, x => relativePath.includes(`${x}${_path.default.sep}`));

    const itemsToKeep = allExtractedItems.map(itemPath => _path.default.relative(tmpRoot, itemPath)).filter(relativePath => isSupportedAppItem(relativePath)).map(relativePath => _path.default.resolve(tmpRoot, relativePath));

    const itemsToRemove = _lodash.default.difference(allExtractedItems, itemsToKeep).filter(itemToRemovePath => !_lodash.default.some(itemsToKeep, itemToKeepPath => itemToKeepPath.startsWith(itemToRemovePath)));

    await _bluebird.default.all(itemsToRemove, async itemPath => {
      if (await _appiumSupport.fs.exists(itemPath)) {
        await _appiumSupport.fs.rimraf(itemPath);
      }
    });
    let allBundleItems = [];
    await _appiumSupport.fs.walkDir(tmpRoot, true, itemPath => void allBundleItems.push(itemPath));
    allBundleItems = allBundleItems.map(itemPath => _path.default.relative(tmpRoot, itemPath)).filter(relativePath => isSupportedAppItem(relativePath)).sort((a, b) => a.split(_path.default.sep).length - b.split(_path.default.sep).length);

    if (_lodash.default.isEmpty(allBundleItems)) {
      throw new Error(`App zip unzipped OK, but we could not find ${supportedAppExtensions} bundle(s) ` + `in it. Make sure your archive contains ${supportedAppExtensions} package(s) ` + `and nothing else`);
    }

    const matchedBundle = _lodash.default.first(allBundleItems);

    _logger.default.debug(`Matched ${allBundleItems.length} item(s) in the extracted archive. ` + `Assuming '${matchedBundle}' is the correct bundle`);

    await _appiumSupport.fs.mv(_path.default.resolve(tmpRoot, matchedBundle), _path.default.resolve(dstRoot, matchedBundle), {
      mkdirp: true
    });
    return _path.default.resolve(dstRoot, matchedBundle);
  } finally {
    await _appiumSupport.fs.rimraf(tmpRoot);
  }
}

function isPackageOrBundle(app) {
  return /^([a-zA-Z0-9\-_]+\.[a-zA-Z0-9\-_]+)+$/.test(app);
}

function getCoordDefault(val) {
  return _appiumSupport.util.hasValue(val) ? val : 0.5;
}

function getSwipeTouchDuration(waitGesture) {
  let duration = 0.8;

  if (typeof waitGesture.options.ms !== 'undefined' && waitGesture.options.ms) {
    duration = waitGesture.options.ms / 1000;

    if (duration === 0) {
      duration = 0.1;
    }
  }

  return duration;
}

function duplicateKeys(input, firstKey, secondKey) {
  if (_lodash.default.isArray(input)) {
    return input.map(item => duplicateKeys(item, firstKey, secondKey));
  }

  if (_lodash.default.isPlainObject(input)) {
    const resultObj = {};

    for (let [key, value] of _lodash.default.toPairs(input)) {
      const recursivelyCalledValue = duplicateKeys(value, firstKey, secondKey);

      if (key === firstKey) {
        resultObj[secondKey] = recursivelyCalledValue;
      } else if (key === secondKey) {
        resultObj[firstKey] = recursivelyCalledValue;
      }

      resultObj[key] = recursivelyCalledValue;
    }

    return resultObj;
  }

  return input;
}

function parseCapsArray(cap) {
  if (_lodash.default.isArray(cap)) {
    return cap;
  }

  let parsedCaps;

  try {
    parsedCaps = JSON.parse(cap);

    if (_lodash.default.isArray(parsedCaps)) {
      return parsedCaps;
    }
  } catch (ign) {
    _logger.default.warn(`Failed to parse capability as JSON array`);
  }

  if (_lodash.default.isString(cap)) {
    return [cap];
  }

  throw new Error(`must provide a string or JSON Array; received ${cap}`);
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2hlbHBlcnMuanMiXSwibmFtZXMiOlsiWklQX0VYVFMiLCJaSVBfTUlNRV9UWVBFUyIsIkNBQ0hFRF9BUFBTX01BWF9BR0UiLCJBUFBMSUNBVElPTlNfQ0FDSEUiLCJMUlUiLCJtYXhBZ2UiLCJ1cGRhdGVBZ2VPbkdldCIsImRpc3Bvc2UiLCJhcHAiLCJmdWxsUGF0aCIsImZzIiwiZXhpc3RzIiwibG9nZ2VyIiwiaW5mbyIsInJpbXJhZiIsIm5vRGlzcG9zZU9uU2V0IiwiQVBQTElDQVRJT05TX0NBQ0hFX0dVQVJEIiwiQXN5bmNMb2NrIiwiU0FOSVRJWkVfUkVQTEFDRU1FTlQiLCJERUZBVUxUX0JBU0VOQU1FIiwicHJvY2VzcyIsIm9uIiwibGVuZ3RoIiwiYXBwUGF0aHMiLCJ2YWx1ZXMiLCJtYXAiLCJkZWJ1ZyIsImFwcFBhdGgiLCJyaW1yYWZTeW5jIiwiZSIsIndhcm4iLCJtZXNzYWdlIiwicmV0cmlldmVIZWFkZXJzIiwibGluayIsInJlc3BvbnNlIiwidXJsIiwibWV0aG9kIiwicmVzb2x2ZVdpdGhGdWxsUmVzcG9uc2UiLCJ0aW1lb3V0IiwiaGVhZGVycyIsImdldENhY2hlZEFwcGxpY2F0aW9uUGF0aCIsImN1cnJlbnRNb2RpZmllZCIsImhhcyIsImxhc3RNb2RpZmllZCIsImdldCIsImdldFRpbWUiLCJ2ZXJpZnlBcHBFeHRlbnNpb24iLCJzdXBwb3J0ZWRBcHBFeHRlbnNpb25zIiwiaW5jbHVkZXMiLCJwYXRoIiwiZXh0bmFtZSIsIkVycm9yIiwiY29uZmlndXJlQXBwIiwiXyIsImlzU3RyaW5nIiwiaXNBcnJheSIsIm5ld0FwcCIsInNob3VsZFVuemlwQXBwIiwiYXJjaGl2ZUhhc2giLCJwcm90b2NvbCIsInBhdGhuYW1lIiwicGFyc2UiLCJpc1VybCIsImFjcXVpcmUiLCJEYXRlIiwiY2FjaGVkUGF0aCIsImRlbCIsImZpbGVOYW1lIiwiYmFzZW5hbWUiLCJkZWNvZGVVUklDb21wb25lbnQiLCJyZXBsYWNlbWVudCIsInNvbWUiLCJtaW1lVHlwZSIsIlJlZ0V4cCIsImVzY2FwZVJlZ0V4cCIsInRlc3QiLCJtYXRjaCIsImV4ZWMiLCJyZXN1bHRpbmdOYW1lIiwic3Vic3RyaW5nIiwicmVzdWx0aW5nRXh0IiwiZmlyc3QiLCJ0YXJnZXRQYXRoIiwidGVtcERpciIsInByZWZpeCIsInN1ZmZpeCIsImRvd25sb2FkQXBwIiwiZXJyb3JNZXNzYWdlIiwiYXJjaGl2ZVBhdGgiLCJoYXNoIiwidG1wUm9vdCIsIm9wZW5EaXIiLCJ1bnppcEFwcCIsImlzQWJzb2x1dGUiLCJyZXNvbHZlIiwiY3dkIiwic2V0IiwiaHJlZiIsInRpbWVyIiwidGltaW5nIiwiVGltZXIiLCJzdGFydCIsIkIiLCJyZWplY3QiLCJyZXMiLCJzdGF0dXNDb2RlIiwic3RhdHVzTWVzc2FnZSIsInBpcGUiLCJfZnMiLCJjcmVhdGVXcml0ZVN0cmVhbSIsImVyciIsInNlY29uZHNFbGFwc2VkIiwiZ2V0RHVyYXRpb24iLCJhc1NlY29uZHMiLCJzaXplIiwic3RhdCIsInV0aWwiLCJ0b1JlYWRhYmxlU2l6ZVN0cmluZyIsInRvRml4ZWQiLCJieXRlc1BlclNlYyIsIk1hdGgiLCJmbG9vciIsInppcFBhdGgiLCJkc3RSb290IiwiemlwIiwiYXNzZXJ0VmFsaWRaaXAiLCJleHRyYWN0QWxsVG8iLCJhbGxFeHRyYWN0ZWRJdGVtcyIsIndhbGtEaXIiLCJpdGVtUGF0aCIsInB1c2giLCJpc1N1cHBvcnRlZEFwcEl0ZW0iLCJyZWxhdGl2ZVBhdGgiLCJ4Iiwic2VwIiwiaXRlbXNUb0tlZXAiLCJyZWxhdGl2ZSIsImZpbHRlciIsIml0ZW1zVG9SZW1vdmUiLCJkaWZmZXJlbmNlIiwiaXRlbVRvUmVtb3ZlUGF0aCIsIml0ZW1Ub0tlZXBQYXRoIiwic3RhcnRzV2l0aCIsImFsbCIsImFsbEJ1bmRsZUl0ZW1zIiwic29ydCIsImEiLCJiIiwic3BsaXQiLCJpc0VtcHR5IiwibWF0Y2hlZEJ1bmRsZSIsIm12IiwibWtkaXJwIiwiaXNQYWNrYWdlT3JCdW5kbGUiLCJnZXRDb29yZERlZmF1bHQiLCJ2YWwiLCJoYXNWYWx1ZSIsImdldFN3aXBlVG91Y2hEdXJhdGlvbiIsIndhaXRHZXN0dXJlIiwiZHVyYXRpb24iLCJvcHRpb25zIiwibXMiLCJkdXBsaWNhdGVLZXlzIiwiaW5wdXQiLCJmaXJzdEtleSIsInNlY29uZEtleSIsIml0ZW0iLCJpc1BsYWluT2JqZWN0IiwicmVzdWx0T2JqIiwia2V5IiwidmFsdWUiLCJ0b1BhaXJzIiwicmVjdXJzaXZlbHlDYWxsZWRWYWx1ZSIsInBhcnNlQ2Fwc0FycmF5IiwiY2FwIiwicGFyc2VkQ2FwcyIsIkpTT04iLCJpZ24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxRQUFRLEdBQUcsQ0FBQyxNQUFELEVBQVMsTUFBVCxDQUFqQjtBQUNBLE1BQU1DLGNBQWMsR0FBRyxDQUNyQixpQkFEcUIsRUFFckIsOEJBRnFCLEVBR3JCLGlCQUhxQixDQUF2QjtBQUtBLE1BQU1DLG1CQUFtQixHQUFHLE9BQU8sRUFBUCxHQUFZLEVBQVosR0FBaUIsRUFBN0M7QUFDQSxNQUFNQyxrQkFBa0IsR0FBRyxJQUFJQyxpQkFBSixDQUFRO0FBQ2pDQyxFQUFBQSxNQUFNLEVBQUVILG1CQUR5QjtBQUVqQ0ksRUFBQUEsY0FBYyxFQUFFLElBRmlCO0FBR2pDQyxFQUFBQSxPQUFPLEVBQUUsT0FBT0MsR0FBUCxFQUFZO0FBQUNDLElBQUFBO0FBQUQsR0FBWixLQUEyQjtBQUNsQyxRQUFJLEVBQUMsTUFBTUMsa0JBQUdDLE1BQUgsQ0FBVUYsUUFBVixDQUFQLENBQUosRUFBZ0M7QUFDOUI7QUFDRDs7QUFFREcsb0JBQU9DLElBQVAsQ0FBYSxvQkFBbUJMLEdBQUksZ0JBQWVDLFFBQVMsZUFBNUQ7O0FBQ0EsVUFBTUMsa0JBQUdJLE1BQUgsQ0FBVUwsUUFBVixDQUFOO0FBQ0QsR0FWZ0M7QUFXakNNLEVB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RDs7QUFRRCxTQUFTVSxjQUFULENBQXlCQyxHQUF6QixFQUE4QjtBQUM1QixNQUFJekgsZ0JBQUVFLE9BQUYsQ0FBVXVILEdBQVYsQ0FBSixFQUFvQjtBQUNsQixXQUFPQSxHQUFQO0FBQ0Q7O0FBRUQsTUFBSUMsVUFBSjs7QUFDQSxNQUFJO0FBQ0ZBLElBQUFBLFVBQVUsR0FBR0MsSUFBSSxDQUFDbkgsS0FBTCxDQUFXaUgsR0FBWCxDQUFiOztBQUNBLFFBQUl6SCxnQkFBRUUsT0FBRixDQUFVd0gsVUFBVixDQUFKLEVBQTJCO0FBQ3pCLGFBQU9BLFVBQVA7QUFDRDtBQUNGLEdBTEQsQ0FLRSxPQUFPRSxHQUFQLEVBQVk7QUFDWnJLLG9CQUFPa0IsSUFBUCxDQUFhLDBDQUFiO0FBQ0Q7O0FBQ0QsTUFBSXVCLGdCQUFFQyxRQUFGLENBQVd3SCxHQUFYLENBQUosRUFBcUI7QUFDbkIsV0FBTyxDQUFDQSxHQUFELENBQVA7QUFDRDs7QUFDRCxRQUFNLElBQUkzSCxLQUFKLENBQVcsaURBQWdEMkgsR0FBSSxFQUEvRCxDQUFOO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgdXJsIGZyb20gJ3VybCc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBfZnMgZnJvbSAnZnMnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgdGVtcERpciwgZnMsIHV0aWwsIHppcCwgdGltaW5nIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHJlcXVlc3QgZnJvbSAncmVxdWVzdCc7XG5pbXBvcnQgYXN5bmNSZXF1ZXN0IGZyb20gJ3JlcXVlc3QtcHJvbWlzZSc7XG5pbXBvcnQgTFJVIGZyb20gJ2xydS1jYWNoZSc7XG5pbXBvcnQgQXN5bmNMb2NrIGZyb20gJ2FzeW5jLWxvY2snO1xuaW1wb3J0IHNhbml0aXplIGZyb20gJ3Nhbml0aXplLWZpbGVuYW1lJztcblxuXG5jb25zdCBaSVBfRVhUUyA9IFsnLnppcCcsICcuaXBhJ107XG5jb25zdCBaSVBfTUlNRV9UWVBFUyA9IFtcbiAgJ2FwcGxpY2F0aW9uL3ppcCcsXG4gICdhcHBsaWNhdGlvbi94LXppcC1jb21wcmVzc2VkJyxcbiAgJ211bHRpcGFydC94LXppcCcsXG5dO1xuY29uc3QgQ0FDSEVEX0FQUFNfTUFYX0FHRSA9IDEwMDAgKiA2MCAqIDYwICogMjQ7IC8vIG1zXG5jb25zdCBBUFBMSUNBVElPTlNfQ0FDSEUgPSBuZXcgTFJVKHtcbiAgbWF4QWdlOiBDQUNIRURfQVBQU19NQVhfQUdFLCAvLyBleHBpcmUgYWZ0ZXIgMjQgaG91cnNcbiAgdXBkYXRlQWdlT25HZXQ6IHRydWUsXG4gIGRpc3Bvc2U6IGFzeW5jIChhcHAsIHtmdWxsUGF0aH0pID0+IHtcbiAgICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhmdWxsUGF0aCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsb2dnZXIuaW5mbyhgVGhlIGFwcGxpY2F0aW9uICcke2FwcH0nIGNhY2hlZCBhdCAnJHtmdWxsUGF0aH0nIGhhcyBleHBpcmVkYCk7XG4gICAgYXdhaXQgZnMucmltcmFmKGZ1bGxQYXRoKTtcbiAgfSxcbiAgbm9EaXNwb3NlT25TZXQ6IHRydWUsXG59KTtcbmNvbnN0IEFQUExJQ0FUSU9OU19DQUNIRV9HVUFSRCA9IG5ldyBBc3luY0xvY2soKTtcbmNvbnN0IFNBTklUSVpFX1JFUExBQ0VNRU5UID0gJy0nO1xuY29uc3QgREVGQVVMVF9CQVNFTkFNRSA9ICdhcHBpdW0tYXBwJztcblxucHJvY2Vzcy5vbignZXhpdCcsICgpID0+IHtcbiAgaWYgKCFBUFBMSUNBVElPTlNfQ0FDSEUubGVuZ3RoKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgYXBwUGF0aHMgPSBBUFBMSUNBVElPTlNfQ0FDSEUudmFsdWVzKClcbiAgICAubWFwKCh7ZnVsbFBhdGh9KSA9PiBmdWxsUGF0aCk7XG4gIGxvZ2dlci5kZWJ1ZyhgUGVyZm9ybWluZyBjbGVhbnVwIG9mICR7YXBwUGF0aHMubGVuZ3RofSBjYWNoZWQgYCArXG4gICAgYGFwcGxpY2F0aW9uJHthcHBQYXRocy5sZW5ndGggPT09IDEgPyAnJyA6ICdzJ31gKTtcbiAgZm9yIChjb25zdCBhcHBQYXRoIG9mIGFwcFBhdGhzKSB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIEFzeW5jaHJvbm91cyBjYWxscyBhcmUgbm90IHN1cHBvcnRlZCBpbiBvbkV4aXQgaGFuZGxlclxuICAgICAgZnMucmltcmFmU3luYyhhcHBQYXRoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2dnZXIud2FybihlLm1lc3NhZ2UpO1xuICAgIH1cbiAgfVxufSk7XG5cblxuYXN5bmMgZnVuY3Rpb24gcmV0cmlldmVIZWFkZXJzIChsaW5rKSB7XG4gIHRyeSB7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBhc3luY1JlcXVlc3Qoe1xuICAgICAgdXJsOiBsaW5rLFxuICAgICAgbWV0aG9kOiAnSEVBRCcsXG4gICAgICByZXNvbHZlV2l0aEZ1bGxSZXNwb25zZTogdHJ1ZSxcbiAgICAgIHRpbWVvdXQ6IDUwMDAsXG4gICAgfSk7XG4gICAgcmV0dXJuIHJlc3BvbnNlLmhlYWRlcnM7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBsb2dnZXIuZGVidWcoYENhbm5vdCBzZW5kIEhFQUQgcmVxdWVzdCB0byAnJHtsaW5rfScuIE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgfVxuICByZXR1cm4ge307XG59XG5cbmZ1bmN0aW9uIGdldENhY2hlZEFwcGxpY2F0aW9uUGF0aCAobGluaywgY3VycmVudE1vZGlmaWVkKSB7XG4gIGlmICghQVBQTElDQVRJT05TX0NBQ0hFLmhhcyhsaW5rKSB8fCAhY3VycmVudE1vZGlmaWVkKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBjb25zdCB7bGFzdE1vZGlmaWVkLCBmdWxsUGF0aH0gPSBBUFBMSUNBVElPTlNfQ0FDSEUuZ2V0KGxpbmspO1xuICBpZiAobGFzdE1vZGlmaWVkICYmIGN1cnJlbnRNb2RpZmllZC5nZXRUaW1lKCkgPD0gbGFzdE1vZGlmaWVkLmdldFRpbWUoKSkge1xuICAgIHJldHVybiBmdWxsUGF0aDtcbiAgfVxuICBsb2dnZXIuZGVidWcoYCdMYXN0LU1vZGlmaWVkJyB0aW1lc3RhbXAgb2YgJyR7bGlua30nIGhhcyBiZWVuIHVwZGF0ZWQuIGAgK1xuICAgIGBBIGZyZXNoIGNvcHkgb2YgdGhlIGFwcGxpY2F0aW9uIGlzIGdvaW5nIHRvIGJlIGRvd25sb2FkZWQuYCk7XG4gIHJldHVybiBudWxsO1xufVxuXG5mdW5jdGlvbiB2ZXJpZnlBcHBFeHRlbnNpb24gKGFwcCwgc3VwcG9ydGVkQXBwRXh0ZW5zaW9ucykge1xuICBpZiAoc3VwcG9ydGVkQXBwRXh0ZW5zaW9ucy5pbmNsdWRlcyhwYXRoLmV4dG5hbWUoYXBwKSkpIHtcbiAgICByZXR1cm4gYXBwO1xuICB9XG4gIHRocm93IG5ldyBFcnJvcihgTmV3IGFwcCBwYXRoICcke2FwcH0nIGRpZCBub3QgaGF2ZSBleHRlbnNpb24ocykgJyR7c3VwcG9ydGVkQXBwRXh0ZW5zaW9uc30nYCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNvbmZpZ3VyZUFwcCAoYXBwLCBzdXBwb3J0ZWRBcHBFeHRlbnNpb25zKSB7XG4gIGlmICghXy5pc1N0cmluZyhhcHApKSB7XG4gICAgLy8gaW1tZWRpYXRlbHkgc2hvcnRjaXJjdWl0IGlmIG5vdCBnaXZlbiBhbiBhcHBcbiAgICByZXR1cm47XG4gIH1cbiAgaWYgKCFfLmlzQXJyYXkoc3VwcG9ydGVkQXBwRXh0ZW5zaW9ucykpIHtcbiAgICBzdXBwb3J0ZWRBcHBFeHRlbnNpb25zID0gW3N1cHBvcnRlZEFwcEV4dGVuc2lvbnNdO1xuICB9XG5cbiAgbGV0IG5ld0FwcCA9IGFwcDtcbiAgbGV0IHNob3VsZFVuemlwQXBwID0gZmFsc2U7XG4gIGxldCBhcmNoaXZlSGFzaCA9IG51bGw7XG4gIGxldCBjdXJyZW50TW9kaWZpZWQgPSBudWxsO1xuICBjb25zdCB7cHJvdG9jb2wsIHBhdGhuYW1lfSA9IHVybC5wYXJzZShuZXdBcHApO1xuICBjb25zdCBpc1VybCA9IFsnaHR0cDonLCAnaHR0cHM6J10uaW5jbHVkZXMocHJvdG9jb2wpO1xuXG4gIHJldHVybiBhd2FpdCBBUFBMSUNBVElPTlNfQ0FDSEVfR1VBUkQuYWNxdWlyZShhcHAsIGFzeW5jICgpID0+IHtcbiAgICBpZiAoaXNVcmwpIHtcbiAgICAgIC8vIFVzZSB0aGUgYXBwIGZyb20gcmVtb3RlIFVSTFxuICAgICAgbG9nZ2VyLmluZm8oYFVzaW5nIGRvd25sb2FkYWJsZSBhcHAgJyR7bmV3QXBwfSdgKTtcbiAgICAgIGNvbnN0IGhlYWRlcnMgPSBhd2FpdCByZXRyaWV2ZUhlYWRlcnMobmV3QXBwKTtcbiAgICAgIGlmIChoZWFkZXJzWydsYXN0LW1vZGlmaWVkJ10pIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKGBBcHAgTGFzdC1Nb2RpZmllZDogJHtoZWFkZXJzWydsYXN0LW1vZGlmaWVkJ119YCk7XG4gICAgICAgIGN1cnJlbnRNb2RpZmllZCA9IG5ldyBEYXRlKGhlYWRlcnNbJ2xhc3QtbW9kaWZpZWQnXSk7XG4gICAgICB9XG4gICAgICBjb25zdCBjYWNoZWRQYXRoID0gZ2V0Q2FjaGVkQXBwbGljYXRpb25QYXRoKGFwcCwgY3VycmVudE1vZGlmaWVkKTtcbiAgICAgIGlmIChjYWNoZWRQYXRoKSB7XG4gICAgICAgIGlmIChhd2FpdCBmcy5leGlzdHMoY2FjaGVkUGF0aCkpIHtcbiAgICAgICAgICBsb2dnZXIuaW5mbyhgUmV1c2luZyBwcmV2aW91c2x5IGRvd25sb2FkZWQgYXBwbGljYXRpb24gYXQgJyR7Y2FjaGVkUGF0aH0nYCk7XG4gICAgICAgICAgcmV0dXJuIHZlcmlmeUFwcEV4dGVuc2lvbihjYWNoZWRQYXRoLCBzdXBwb3J0ZWRBcHBFeHRlbnNpb25zKTtcbiAgICAgICAgfVxuICAgICAgICBsb2dnZXIuaW5mbyhgVGhlIGFwcGxpY2F0aW9uIGF0ICcke2NhY2hlZFBhdGh9JyBkb2VzIG5vdCBleGlzdCBhbnltb3JlLiBEZWxldGluZyBpdCBmcm9tIHRoZSBjYWNoZWApO1xuICAgICAgICBBUFBMSUNBVElPTlNfQ0FDSEUuZGVsKGFwcCk7XG4gICAgICB9XG5cbiAgICAgIGxldCBmaWxlTmFtZSA9IG51bGw7XG4gICAgICBjb25zdCBiYXNlbmFtZSA9IHNhbml0aXplKHBhdGguYmFzZW5hbWUoZGVjb2RlVVJJQ29tcG9uZW50KHBhdGhuYW1lKSksIHtcbiAgICAgICAgcmVwbGFjZW1lbnQ6IFNBTklUSVpFX1JFUExBQ0VNRU5UXG4gICAgICB9KTtcbiAgICAgIGNvbnN0IGV4dG5hbWUgPSBwYXRoLmV4dG5hbWUoYmFzZW5hbWUpO1xuICAgICAgLy8gdG8gZGV0ZXJtaW5lIGlmIHdlIG5lZWQgdG8gdW56aXAgdGhlIGFwcCwgd2UgaGF2ZSBhIG51bWJlciBvZiBwbGFjZXNcbiAgICAgIC8vIHRvIGxvb2s6IGNvbnRlbnQgdHlwZSwgY29udGVudCBkaXNwb3NpdGlvbiwgb3IgdGhlIGZpbGUgZXh0ZW5zaW9uXG4gICAgICBpZiAoWklQX0VYVFMuaW5jbHVkZXMoZXh0bmFtZSkpIHtcbiAgICAgICAgZmlsZU5hbWUgPSBiYXNlbmFtZTtcbiAgICAgICAgc2hvdWxkVW56aXBBcHAgPSB0cnVlO1xuICAgICAgfVxuICAgICAgaWYgKGhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddKSB7XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhgQ29udGVudC1UeXBlOiAke2hlYWRlcnNbJ2NvbnRlbnQtdHlwZSddfWApO1xuICAgICAgICAvLyB0aGUgZmlsZXR5cGUgbWF5IG5vdCBiZSBvYnZpb3VzIGZvciBjZXJ0YWluIHVybHMsIHNvIGNoZWNrIHRoZSBtaW1lIHR5cGUgdG9vXG4gICAgICAgIGlmIChaSVBfTUlNRV9UWVBFUy5zb21lKG1pbWVUeXBlID0+IG5ldyBSZWdFeHAoYFxcXFxiJHtfLmVzY2FwZVJlZ0V4cChtaW1lVHlwZSl9XFxcXGJgKS50ZXN0KGhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddKSkpIHtcbiAgICAgICAgICBpZiAoIWZpbGVOYW1lKSB7XG4gICAgICAgICAgICBmaWxlTmFtZSA9IGAke0RFRkFVTFRfQkFTRU5BTUV9LnppcGA7XG4gICAgICAgICAgfVxuICAgICAgICAgIHNob3VsZFVuemlwQXBwID0gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKGhlYWRlcnNbJ2NvbnRlbnQtZGlzcG9zaXRpb24nXSAmJiAvXmF0dGFjaG1lbnQvaS50ZXN0KGhlYWRlcnNbJ2NvbnRlbnQtZGlzcG9zaXRpb24nXSkpIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKGBDb250ZW50LURpc3Bvc2l0aW9uOiAke2hlYWRlcnNbJ2NvbnRlbnQtZGlzcG9zaXRpb24nXX1gKTtcbiAgICAgICAgY29uc3QgbWF0Y2ggPSAvZmlsZW5hbWU9XCIoW15cIl0rKS9pLmV4ZWMoaGVhZGVyc1snY29udGVudC1kaXNwb3NpdGlvbiddKTtcbiAgICAgICAgaWYgKG1hdGNoKSB7XG4gICAgICAgICAgZmlsZU5hbWUgPSBzYW5pdGl6ZShtYXRjaFsxXSwge1xuICAgICAgICAgICAgcmVwbGFjZW1lbnQ6IFNBTklUSVpFX1JFUExBQ0VNRU5UXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgc2hvdWxkVW56aXBBcHAgPSBzaG91bGRVbnppcEFwcCB8fCBaSVBfRVhUUy5pbmNsdWRlcyhwYXRoLmV4dG5hbWUoZmlsZU5hbWUpKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKCFmaWxlTmFtZSkge1xuICAgICAgICAvLyBhc3NpZ24gdGhlIGRlZmF1bHQgZmlsZSBuYW1lIGFuZCB0aGUgZXh0ZW5zaW9uIGlmIG5vbmUgaGFzIGJlZW4gZGV0ZWN0ZWRcbiAgICAgICAgY29uc3QgcmVzdWx0aW5nTmFtZSA9IGJhc2VuYW1lXG4gICAgICAgICAgPyBiYXNlbmFtZS5zdWJzdHJpbmcoMCwgYmFzZW5hbWUubGVuZ3RoIC0gZXh0bmFtZS5sZW5ndGgpXG4gICAgICAgICAgOiBERUZBVUxUX0JBU0VOQU1FO1xuICAgICAgICBsZXQgcmVzdWx0aW5nRXh0ID0gZXh0bmFtZTtcbiAgICAgICAgaWYgKCFzdXBwb3J0ZWRBcHBFeHRlbnNpb25zLmluY2x1ZGVzKHJlc3VsdGluZ0V4dCkpIHtcbiAgICAgICAgICBsb2dnZXIuaW5mbyhgVGhlIGN1cnJlbnQgZmlsZSBleHRlbnNpb24gJyR7cmVzdWx0aW5nRXh0fScgaXMgbm90IHN1cHBvcnRlZC4gYCArXG4gICAgICAgICAgICBgRGVmYXVsdGluZyB0byAnJHtfLmZpcnN0KHN1cHBvcnRlZEFwcEV4dGVuc2lvbnMpfSdgKTtcbiAgICAgICAgICByZXN1bHRpbmdFeHQgPSBfLmZpcnN0KHN1cHBvcnRlZEFwcEV4dGVuc2lvbnMpO1xuICAgICAgICB9XG4gICAgICAgIGZpbGVOYW1lID0gYCR7cmVzdWx0aW5nTmFtZX0ke3Jlc3VsdGluZ0V4dH1gO1xuICAgICAgfVxuICAgICAgY29uc3QgdGFyZ2V0UGF0aCA9IGF3YWl0IHRlbXBEaXIucGF0aCh7XG4gICAgICAgIHByZWZpeDogZmlsZU5hbWUsXG4gICAgICAgIHN1ZmZpeDogJycsXG4gICAgICB9KTtcbiAgICAgIG5ld0FwcCA9IGF3YWl0IGRvd25sb2FkQXBwKG5ld0FwcCwgdGFyZ2V0UGF0aCk7XG4gICAgfSBlbHNlIGlmIChhd2FpdCBmcy5leGlzdHMobmV3QXBwKSkge1xuICAgICAgLy8gVXNlIHRoZSBsb2NhbCBhcHBcbiAgICAgIGxvZ2dlci5pbmZvKGBVc2luZyBsb2NhbCBhcHAgJyR7bmV3QXBwfSdgKTtcbiAgICAgIHNob3VsZFVuemlwQXBwID0gWklQX0VYVFMuaW5jbHVkZXMocGF0aC5leHRuYW1lKG5ld0FwcCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgZXJyb3JNZXNzYWdlID0gYFRoZSBhcHBsaWNhdGlvbiBhdCAnJHtuZXdBcHB9JyBkb2VzIG5vdCBleGlzdCBvciBpcyBub3QgYWNjZXNzaWJsZWA7XG4gICAgICAvLyBwcm90b2NvbCB2YWx1ZSBmb3IgJ0M6XFxcXHRlbXAnIGlzICdjOicsIHNvIHdlIGNoZWNrIHRoZSBsZW5ndGggYXMgd2VsbFxuICAgICAgaWYgKF8uaXNTdHJpbmcocHJvdG9jb2wpICYmIHByb3RvY29sLmxlbmd0aCA+IDIpIHtcbiAgICAgICAgZXJyb3JNZXNzYWdlID0gYFRoZSBwcm90b2NvbCAnJHtwcm90b2NvbH0nIHVzZWQgaW4gJyR7bmV3QXBwfScgaXMgbm90IHN1cHBvcnRlZC4gYCArXG4gICAgICAgICAgYE9ubHkgaHR0cDogYW5kIGh0dHBzOiBwcm90b2NvbHMgYXJlIHN1cHBvcnRlZGA7XG4gICAgICB9XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyb3JNZXNzYWdlKTtcbiAgICB9XG5cbiAgICBpZiAoc2hvdWxkVW56aXBBcHApIHtcbiAgICAgIGNvbnN0IGFyY2hpdmVQYXRoID0gbmV3QXBwO1xuICAgICAgYXJjaGl2ZUhhc2ggPSBhd2FpdCBmcy5oYXNoKGFyY2hpdmVQYXRoKTtcbiAgICAgIGlmIChBUFBMSUNBVElPTlNfQ0FDSEUuaGFzKGFwcCkgJiYgYXJjaGl2ZUhhc2ggPT09IEFQUExJQ0FUSU9OU19DQUNIRS5nZXQoYXBwKS5oYXNoKSB7XG4gICAgICAgIGNvbnN0IHtmdWxsUGF0aH0gPSBBUFBMSUNBVElPTlNfQ0FDSEUuZ2V0KGFwcCk7XG4gICAgICAgIGlmIChhd2FpdCBmcy5leGlzdHMoZnVsbFBhdGgpKSB7XG4gICAgICAgICAgaWYgKGFyY2hpdmVQYXRoICE9PSBhcHApIHtcbiAgICAgICAgICAgIGF3YWl0IGZzLnJpbXJhZihhcmNoaXZlUGF0aCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIGxvZ2dlci5pbmZvKGBXaWxsIHJldXNlIHByZXZpb3VzbHkgY2FjaGVkIGFwcGxpY2F0aW9uIGF0ICcke2Z1bGxQYXRofSdgKTtcbiAgICAgICAgICByZXR1cm4gdmVyaWZ5QXBwRXh0ZW5zaW9uKGZ1bGxQYXRoLCBzdXBwb3J0ZWRBcHBFeHRlbnNpb25zKTtcbiAgICAgICAgfVxuICAgICAgICBsb2dnZXIuaW5mbyhgVGhlIGFwcGxpY2F0aW9uIGF0ICcke2Z1bGxQYXRofScgZG9lcyBub3QgZXhpc3QgYW55bW9yZS4gRGVsZXRpbmcgaXQgZnJvbSB0aGUgY2FjaGVgKTtcbiAgICAgICAgQVBQTElDQVRJT05TX0NBQ0hFLmRlbChhcHApO1xuICAgICAgfVxuICAgICAgY29uc3QgdG1wUm9vdCA9IGF3YWl0IHRlbXBEaXIub3BlbkRpcigpO1xuICAgICAgdHJ5IHtcbiAgICAgICAgbmV3QXBwID0gYXdhaXQgdW56aXBBcHAoYXJjaGl2ZVBhdGgsIHRtcFJvb3QsIHN1cHBvcnRlZEFwcEV4dGVuc2lvbnMpO1xuICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgaWYgKG5ld0FwcCAhPT0gYXJjaGl2ZVBhdGggJiYgYXJjaGl2ZVBhdGggIT09IGFwcCkge1xuICAgICAgICAgIGF3YWl0IGZzLnJpbXJhZihhcmNoaXZlUGF0aCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGxvZ2dlci5pbmZvKGBVbnppcHBlZCBsb2NhbCBhcHAgdG8gJyR7bmV3QXBwfSdgKTtcbiAgICB9IGVsc2UgaWYgKCFwYXRoLmlzQWJzb2x1dGUobmV3QXBwKSkge1xuICAgICAgbmV3QXBwID0gcGF0aC5yZXNvbHZlKHByb2Nlc3MuY3dkKCksIG5ld0FwcCk7XG4gICAgICBsb2dnZXIud2FybihgVGhlIGN1cnJlbnQgYXBwbGljYXRpb24gcGF0aCAnJHthcHB9JyBpcyBub3QgYWJzb2x1dGUgYCArXG4gICAgICAgIGBhbmQgaGFzIGJlZW4gcmV3cml0dGVuIHRvICcke25ld0FwcH0nLiBDb25zaWRlciB1c2luZyBhYnNvbHV0ZSBwYXRocyByYXRoZXIgdGhhbiByZWxhdGl2ZWApO1xuICAgICAgYXBwID0gbmV3QXBwO1xuICAgIH1cblxuICAgIHZlcmlmeUFwcEV4dGVuc2lvbihuZXdBcHAsIHN1cHBvcnRlZEFwcEV4dGVuc2lvbnMpO1xuXG4gICAgaWYgKGFwcCAhPT0gbmV3QXBwICYmIChhcmNoaXZlSGFzaCB8fCBjdXJyZW50TW9kaWZpZWQpKSB7XG4gICAgICBpZiAoQVBQTElDQVRJT05TX0NBQ0hFLmhhcyhhcHApKSB7XG4gICAgICAgIGNvbnN0IHtmdWxsUGF0aH0gPSBBUFBMSUNBVElPTlNfQ0FDSEUuZ2V0KGFwcCk7XG4gICAgICAgIC8vIENsZWFuIHVwIHRoZSBvYnNvbGV0ZSBlbnRyeSBmaXJzdCBpZiBuZWVkZWRcbiAgICAgICAgaWYgKGZ1bGxQYXRoICE9PSBuZXdBcHAgJiYgYXdhaXQgZnMuZXhpc3RzKGZ1bGxQYXRoKSkge1xuICAgICAgICAgIGF3YWl0IGZzLnJpbXJhZihmdWxsUGF0aCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIEFQUExJQ0FUSU9OU19DQUNIRS5zZXQoYXBwLCB7XG4gICAgICAgIGhhc2g6IGFyY2hpdmVIYXNoLFxuICAgICAgICBsYXN0TW9kaWZpZWQ6IGN1cnJlbnRNb2RpZmllZCxcbiAgICAgICAgZnVsbFBhdGg6IG5ld0FwcCxcbiAgICAgIH0pO1xuICAgIH1cbiAgICByZXR1cm4gbmV3QXBwO1xuICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZG93bmxvYWRBcHAgKGFwcCwgdGFyZ2V0UGF0aCkge1xuICBjb25zdCB7aHJlZn0gPSB1cmwucGFyc2UoYXBwKTtcbiAgY29uc3QgdGltZXIgPSBuZXcgdGltaW5nLlRpbWVyKCkuc3RhcnQoKTtcbiAgdHJ5IHtcbiAgICAvLyBkb24ndCB1c2UgcmVxdWVzdC1wcm9taXNlIGhlcmUsIHdlIG5lZWQgc3RyZWFtc1xuICAgIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHJlcXVlc3QoaHJlZilcbiAgICAgICAgLm9uKCdlcnJvcicsIHJlamVjdCkgLy8gaGFuZGxlIHJlYWwgZXJyb3JzLCBsaWtlIGNvbm5lY3Rpb24gZXJyb3JzXG4gICAgICAgIC5vbigncmVzcG9uc2UnLCAocmVzKSA9PiB7XG4gICAgICAgICAgLy8gaGFuZGxlIHJlc3BvbnNlcyB0aGF0IGZhaWwsIGxpa2UgNDA0c1xuICAgICAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSA+PSA0MDApIHtcbiAgICAgICAgICAgIHJldHVybiByZWplY3QobmV3IEVycm9yKGAke3Jlcy5zdGF0dXNDb2RlfSAtICR7cmVzLnN0YXR1c01lc3NhZ2V9YCkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSlcbiAgICAgICAgLnBpcGUoX2ZzLmNyZWF0ZVdyaXRlU3RyZWFtKHRhcmdldFBhdGgpKVxuICAgICAgICAub24oJ2Nsb3NlJywgcmVzb2x2ZSk7XG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHRocm93IG5ldyBFcnJvcihgUHJvYmxlbSBkb3dubG9hZGluZyBhcHAgZnJvbSB1cmwgJHtocmVmfTogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuICBjb25zdCBzZWNvbmRzRWxhcHNlZCA9IHRpbWVyLmdldER1cmF0aW9uKCkuYXNTZWNvbmRzO1xuICBjb25zdCB7c2l6ZX0gPSBhd2FpdCBmcy5zdGF0KHRhcmdldFBhdGgpO1xuICBsb2dnZXIuZGVidWcoYCcke2hyZWZ9JyAoJHt1dGlsLnRvUmVhZGFibGVTaXplU3RyaW5nKHNpemUpfSkgYCArXG4gICAgYGhhcyBiZWVuIGRvd25sb2FkZWQgdG8gJyR7dGFyZ2V0UGF0aH0nIGluICR7c2Vjb25kc0VsYXBzZWQudG9GaXhlZCgzKX1zYCk7XG4gIGlmIChzZWNvbmRzRWxhcHNlZCA+PSAyKSB7XG4gICAgY29uc3QgYnl0ZXNQZXJTZWMgPSBNYXRoLmZsb29yKHNpemUgLyBzZWNvbmRzRWxhcHNlZCk7XG4gICAgbG9nZ2VyLmRlYnVnKGBBcHByb3hpbWF0ZSBkb3dubG9hZCBzcGVlZDogJHt1dGlsLnRvUmVhZGFibGVTaXplU3RyaW5nKGJ5dGVzUGVyU2VjKX0vc2ApO1xuICB9XG4gIHJldHVybiB0YXJnZXRQYXRoO1xufVxuXG5hc3luYyBmdW5jdGlvbiB1bnppcEFwcCAoemlwUGF0aCwgZHN0Um9vdCwgc3VwcG9ydGVkQXBwRXh0ZW5zaW9ucykge1xuICBhd2FpdCB6aXAuYXNzZXJ0VmFsaWRaaXAoemlwUGF0aCk7XG5cbiAgaWYgKCFfLmlzQXJyYXkoc3VwcG9ydGVkQXBwRXh0ZW5zaW9ucykpIHtcbiAgICBzdXBwb3J0ZWRBcHBFeHRlbnNpb25zID0gW3N1cHBvcnRlZEFwcEV4dGVuc2lvbnNdO1xuICB9XG5cbiAgY29uc3QgdG1wUm9vdCA9IGF3YWl0IHRlbXBEaXIub3BlbkRpcigpO1xuICB0cnkge1xuICAgIGxvZ2dlci5kZWJ1ZyhgVW56aXBwaW5nICcke3ppcFBhdGh9J2ApO1xuICAgIGF3YWl0IHppcC5leHRyYWN0QWxsVG8oemlwUGF0aCwgdG1wUm9vdCk7XG4gICAgY29uc3QgYWxsRXh0cmFjdGVkSXRlbXMgPSBbXTtcbiAgICBhd2FpdCBmcy53YWxrRGlyKHRtcFJvb3QsIHRydWUsIChpdGVtUGF0aCkgPT4gdm9pZCBhbGxFeHRyYWN0ZWRJdGVtcy5wdXNoKGl0ZW1QYXRoKSk7XG4gICAgbG9nZ2VyLmRlYnVnKGBFeHRyYWN0ZWQgJHthbGxFeHRyYWN0ZWRJdGVtcy5sZW5ndGh9IGl0ZW0ocykgZnJvbSAnJHt6aXBQYXRofSdgKTtcbiAgICBjb25zdCBpc1N1cHBvcnRlZEFwcEl0ZW0gPSAocmVsYXRpdmVQYXRoKSA9PiBzdXBwb3J0ZWRBcHBFeHRlbnNpb25zLmluY2x1ZGVzKHBhdGguZXh0bmFtZShyZWxhdGl2ZVBhdGgpKVxuICAgICAgfHwgXy5zb21lKHN1cHBvcnRlZEFwcEV4dGVuc2lvbnMsICh4KSA9PiByZWxhdGl2ZVBhdGguaW5jbHVkZXMoYCR7eH0ke3BhdGguc2VwfWApKTtcbiAgICBjb25zdCBpdGVtc1RvS2VlcCA9IGFsbEV4dHJhY3RlZEl0ZW1zXG4gICAgICAubWFwKChpdGVtUGF0aCkgPT4gcGF0aC5yZWxhdGl2ZSh0bXBSb290LCBpdGVtUGF0aCkpXG4gICAgICAuZmlsdGVyKChyZWxhdGl2ZVBhdGgpID0+IGlzU3VwcG9ydGVkQXBwSXRlbShyZWxhdGl2ZVBhdGgpKVxuICAgICAgLm1hcCgocmVsYXRpdmVQYXRoKSA9PiBwYXRoLnJlc29sdmUodG1wUm9vdCwgcmVsYXRpdmVQYXRoKSk7XG4gICAgY29uc3QgaXRlbXNUb1JlbW92ZSA9IF8uZGlmZmVyZW5jZShhbGxFeHRyYWN0ZWRJdGVtcywgaXRlbXNUb0tlZXApXG4gICAgICAvLyBBdm9pZCBwYXJlbnQgZm9sZGVycyB0byBiZSByZWN1cnNpdmVseSByZW1vdmVkXG4gICAgICAuZmlsdGVyKChpdGVtVG9SZW1vdmVQYXRoKSA9PiAhXy5zb21lKGl0ZW1zVG9LZWVwLCAoaXRlbVRvS2VlcFBhdGgpID0+IGl0ZW1Ub0tlZXBQYXRoLnN0YXJ0c1dpdGgoaXRlbVRvUmVtb3ZlUGF0aCkpKTtcbiAgICBhd2FpdCBCLmFsbChpdGVtc1RvUmVtb3ZlLCBhc3luYyAoaXRlbVBhdGgpID0+IHtcbiAgICAgIGlmIChhd2FpdCBmcy5leGlzdHMoaXRlbVBhdGgpKSB7XG4gICAgICAgIGF3YWl0IGZzLnJpbXJhZihpdGVtUGF0aCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgbGV0IGFsbEJ1bmRsZUl0ZW1zID0gW107XG4gICAgYXdhaXQgZnMud2Fsa0Rpcih0bXBSb290LCB0cnVlLCAoaXRlbVBhdGgpID0+IHZvaWQgYWxsQnVuZGxlSXRlbXMucHVzaChpdGVtUGF0aCkpO1xuICAgIGFsbEJ1bmRsZUl0ZW1zID0gYWxsQnVuZGxlSXRlbXNcbiAgICAgIC5tYXAoKGl0ZW1QYXRoKSA9PiBwYXRoLnJlbGF0aXZlKHRtcFJvb3QsIGl0ZW1QYXRoKSlcbiAgICAgIC5maWx0ZXIoKHJlbGF0aXZlUGF0aCkgPT4gaXNTdXBwb3J0ZWRBcHBJdGVtKHJlbGF0aXZlUGF0aCkpXG4gICAgICAvLyBHZXQgdGhlIHRvcCBsZXZlbCBtYXRjaFxuICAgICAgLnNvcnQoKGEsIGIpID0+IGEuc3BsaXQocGF0aC5zZXApLmxlbmd0aCAtIGIuc3BsaXQocGF0aC5zZXApLmxlbmd0aCk7XG4gICAgaWYgKF8uaXNFbXB0eShhbGxCdW5kbGVJdGVtcykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQXBwIHppcCB1bnppcHBlZCBPSywgYnV0IHdlIGNvdWxkIG5vdCBmaW5kICR7c3VwcG9ydGVkQXBwRXh0ZW5zaW9uc30gYnVuZGxlKHMpIGAgK1xuICAgICAgICBgaW4gaXQuIE1ha2Ugc3VyZSB5b3VyIGFyY2hpdmUgY29udGFpbnMgJHtzdXBwb3J0ZWRBcHBFeHRlbnNpb25zfSBwYWNrYWdlKHMpIGAgK1xuICAgICAgICBgYW5kIG5vdGhpbmcgZWxzZWApO1xuICAgIH1cbiAgICBjb25zdCBtYXRjaGVkQnVuZGxlID0gXy5maXJzdChhbGxCdW5kbGVJdGVtcyk7XG4gICAgbG9nZ2VyLmRlYnVnKGBNYXRjaGVkICR7YWxsQnVuZGxlSXRlbXMubGVuZ3RofSBpdGVtKHMpIGluIHRoZSBleHRyYWN0ZWQgYXJjaGl2ZS4gYCArXG4gICAgICBgQXNzdW1pbmcgJyR7bWF0Y2hlZEJ1bmRsZX0nIGlzIHRoZSBjb3JyZWN0IGJ1bmRsZWApO1xuICAgIGF3YWl0IGZzLm12KHBhdGgucmVzb2x2ZSh0bXBSb290LCBtYXRjaGVkQnVuZGxlKSwgcGF0aC5yZXNvbHZlKGRzdFJvb3QsIG1hdGNoZWRCdW5kbGUpLCB7XG4gICAgICBta2RpcnA6IHRydWVcbiAgICB9KTtcbiAgICByZXR1cm4gcGF0aC5yZXNvbHZlKGRzdFJvb3QsIG1hdGNoZWRCdW5kbGUpO1xuICB9IGZpbmFsbHkge1xuICAgIGF3YWl0IGZzLnJpbXJhZih0bXBSb290KTtcbiAgfVxufVxuXG5mdW5jdGlvbiBpc1BhY2thZ2VPckJ1bmRsZSAoYXBwKSB7XG4gIHJldHVybiAoL14oW2EtekEtWjAtOVxcLV9dK1xcLlthLXpBLVowLTlcXC1fXSspKyQvKS50ZXN0KGFwcCk7XG59XG5cbmZ1bmN0aW9uIGdldENvb3JkRGVmYXVsdCAodmFsKSB7XG4gIC8vIGdvaW5nIHRoZSBsb25nIHdheSBhbmQgY2hlY2tpbmcgZm9yIHVuZGVmaW5lZCBhbmQgbnVsbCBzaW5jZVxuICAvLyB3ZSBjYW4ndCBiZSBhc3N1cmVkIGBlbElkYCBpcyBhIHN0cmluZyBhbmQgbm90IGFuIGludC4gU2FtZVxuICAvLyB0aGluZyB3aXRoIGRlc3RFbGVtZW50IGJlbG93LlxuICByZXR1cm4gdXRpbC5oYXNWYWx1ZSh2YWwpID8gdmFsIDogMC41O1xufVxuXG5mdW5jdGlvbiBnZXRTd2lwZVRvdWNoRHVyYXRpb24gKHdhaXRHZXN0dXJlKSB7XG4gIC8vIHRoZSB0b3VjaCBhY3Rpb24gYXBpIHVzZXMgbXMsIHdlIHdhbnQgc2Vjb25kc1xuICAvLyAwLjggaXMgdGhlIGRlZmF1bHQgdGltZSBmb3IgdGhlIG9wZXJhdGlvblxuICBsZXQgZHVyYXRpb24gPSAwLjg7XG4gIGlmICh0eXBlb2Ygd2FpdEdlc3R1cmUub3B0aW9ucy5tcyAhPT0gJ3VuZGVmaW5lZCcgJiYgd2FpdEdlc3R1cmUub3B0aW9ucy5tcykge1xuICAgIGR1cmF0aW9uID0gd2FpdEdlc3R1cmUub3B0aW9ucy5tcyAvIDEwMDA7XG4gICAgaWYgKGR1cmF0aW9uID09PSAwKSB7XG4gICAgICAvLyBzZXQgdG8gYSB2ZXJ5IGxvdyBudW1iZXIsIHNpbmNlIHRoZXkgd2FudGVkIGl0IGZhc3RcbiAgICAgIC8vIGJ1dCBiZWxvdyAwLjEgYmVjb21lcyAwIHN0ZXBzLCB3aGljaCBjYXVzZXMgZXJyb3JzXG4gICAgICBkdXJhdGlvbiA9IDAuMTtcbiAgICB9XG4gIH1cbiAgcmV0dXJuIGR1cmF0aW9uO1xufVxuXG4vKipcbiAqIEZpbmRzIGFsbCBpbnN0YW5jZXMgJ2ZpcnN0S2V5JyBhbmQgY3JlYXRlIGEgZHVwbGljYXRlIHdpdGggdGhlIGtleSAnc2Vjb25kS2V5JyxcbiAqIERvIHRoZSBzYW1lIHRoaW5nIGluIHJldmVyc2UuIElmIHdlIGZpbmQgJ3NlY29uZEtleScsIGNyZWF0ZSBhIGR1cGxpY2F0ZSB3aXRoIHRoZSBrZXkgJ2ZpcnN0S2V5Jy5cbiAqXG4gKiBUaGlzIHdpbGwgY2F1c2Uga2V5cyB0byBiZSBvdmVyd3JpdHRlbiBpZiB0aGUgb2JqZWN0IGNvbnRhaW5zICdmaXJzdEtleScgYW5kICdzZWNvbmRLZXknLlxuXG4gKiBAcGFyYW0geyp9IGlucHV0IEFueSB0eXBlIG9mIGlucHV0XG4gKiBAcGFyYW0ge1N0cmluZ30gZmlyc3RLZXkgVGhlIGZpcnN0IGtleSB0byBkdXBsaWNhdGVcbiAqIEBwYXJhbSB7U3RyaW5nfSBzZWNvbmRLZXkgVGhlIHNlY29uZCBrZXkgdG8gZHVwbGljYXRlXG4gKi9cbmZ1bmN0aW9uIGR1cGxpY2F0ZUtleXMgKGlucHV0LCBmaXJzdEtleSwgc2Vjb25kS2V5KSB7XG4gIC8vIElmIGFycmF5IHByb3ZpZGVkLCByZWN1cnNpdmVseSBjYWxsIG9uIGFsbCBlbGVtZW50c1xuICBpZiAoXy5pc0FycmF5KGlucHV0KSkge1xuICAgIHJldHVybiBpbnB1dC5tYXAoKGl0ZW0pID0+IGR1cGxpY2F0ZUtleXMoaXRlbSwgZmlyc3RLZXksIHNlY29uZEtleSkpO1xuICB9XG5cbiAgLy8gSWYgb2JqZWN0LCBjcmVhdGUgZHVwbGljYXRlcyBmb3Iga2V5cyBhbmQgdGhlbiByZWN1cnNpdmVseSBjYWxsIG9uIHZhbHVlc1xuICBpZiAoXy5pc1BsYWluT2JqZWN0KGlucHV0KSkge1xuICAgIGNvbnN0IHJlc3VsdE9iaiA9IHt9O1xuICAgIGZvciAobGV0IFtrZXksIHZhbHVlXSBvZiBfLnRvUGFpcnMoaW5wdXQpKSB7XG4gICAgICBjb25zdCByZWN1cnNpdmVseUNhbGxlZFZhbHVlID0gZHVwbGljYXRlS2V5cyh2YWx1ZSwgZmlyc3RLZXksIHNlY29uZEtleSk7XG4gICAgICBpZiAoa2V5ID09PSBmaXJzdEtleSkge1xuICAgICAgICByZXN1bHRPYmpbc2Vjb25kS2V5XSA9IHJlY3Vyc2l2ZWx5Q2FsbGVkVmFsdWU7XG4gICAgICB9IGVsc2UgaWYgKGtleSA9PT0gc2Vjb25kS2V5KSB7XG4gICAgICAgIHJlc3VsdE9ialtmaXJzdEtleV0gPSByZWN1cnNpdmVseUNhbGxlZFZhbHVlO1xuICAgICAgfVxuICAgICAgcmVzdWx0T2JqW2tleV0gPSByZWN1cnNpdmVseUNhbGxlZFZhbHVlO1xuICAgIH1cbiAgICByZXR1cm4gcmVzdWx0T2JqO1xuICB9XG5cbiAgLy8gQmFzZSBjYXNlLiBSZXR1cm4gcHJpbWl0aXZlcyB3aXRob3V0IGRvaW5nIGFueXRoaW5nLlxuICByZXR1cm4gaW5wdXQ7XG59XG5cbi8qKlxuICogVGFrZXMgYSBkZXNpcmVkIGNhcGFiaWxpdHkgYW5kIHRyaWVzIHRvIEpTT04ucGFyc2UgaXQgYXMgYW4gYXJyYXksXG4gKiBhbmQgZWl0aGVyIHJldHVybnMgdGhlIHBhcnNlZCBhcnJheSBvciBhIHNpbmdsZXRvbiBhcnJheS5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ3xBcnJheTxTdHJpbmc+fSBjYXAgQSBkZXNpcmVkIGNhcGFiaWxpdHlcbiAqL1xuZnVuY3Rpb24gcGFyc2VDYXBzQXJyYXkgKGNhcCkge1xuICBpZiAoXy5pc0FycmF5KGNhcCkpIHtcbiAgICByZXR1cm4gY2FwO1xuICB9XG5cbiAgbGV0IHBhcnNlZENhcHM7XG4gIHRyeSB7XG4gICAgcGFyc2VkQ2FwcyA9IEpTT04ucGFyc2UoY2FwKTtcbiAgICBpZiAoXy5pc0FycmF5KHBhcnNlZENhcHMpKSB7XG4gICAgICByZXR1cm4gcGFyc2VkQ2FwcztcbiAgICB9XG4gIH0gY2F0Y2ggKGlnbikge1xuICAgIGxvZ2dlci53YXJuKGBGYWlsZWQgdG8gcGFyc2UgY2FwYWJpbGl0eSBhcyBKU09OIGFycmF5YCk7XG4gIH1cbiAgaWYgKF8uaXNTdHJpbmcoY2FwKSkge1xuICAgIHJldHVybiBbY2FwXTtcbiAgfVxuICB0aHJvdyBuZXcgRXJyb3IoYG11c3QgcHJvdmlkZSBhIHN0cmluZyBvciBKU09OIEFycmF5OyByZWNlaXZlZCAke2NhcH1gKTtcbn1cblxuZXhwb3J0IHtcbiAgY29uZmlndXJlQXBwLCBpc1BhY2thZ2VPckJ1bmRsZSwgZ2V0Q29vcmREZWZhdWx0LCBnZXRTd2lwZVRvdWNoRHVyYXRpb24sIGR1cGxpY2F0ZUtleXMsIHBhcnNlQ2Fwc0FycmF5XG59O1xuIl0sImZpbGUiOiJsaWIvYmFzZWRyaXZlci9oZWxwZXJzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
