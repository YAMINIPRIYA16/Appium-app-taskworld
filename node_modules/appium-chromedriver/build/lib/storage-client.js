"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _utils = require("./utils");

var _lodash = _interopRequireDefault(require("lodash"));

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _request = _interopRequireDefault(require("request"));

var _xpath = _interopRequireDefault(require("xpath"));

var _xmldom = require("xmldom");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

const STORAGE_URL = 'https://chromedriver.storage.googleapis.com';
const TIMEOUT_MS = 15000;
const MAX_PARALLEL_DOWNLOADS = 5;

const log = _appiumSupport.logger.getLogger('ChromedriverStorageClient');

async function getOsInfo() {
  let name = 'linux';

  if (_appiumSupport.system.isWindows()) {
    name = 'win';
  } else if (_appiumSupport.system.isMac()) {
    name = 'mac';
  }

  return {
    name,
    arch: await _appiumSupport.system.arch()
  };
}

async function isCrcOk(src, checksum) {
  const md5 = await _appiumSupport.fs.hash(src, 'md5');
  return _lodash.default.toLower(md5) === _lodash.default.toLower(checksum);
}

function findChildNode(parent, childName = null, text = null) {
  if (!childName && !text) {
    return null;
  }

  if (!parent.hasChildNodes()) {
    return null;
  }

  for (let childNodeIdx = 0; childNodeIdx < parent.childNodes.length; childNodeIdx++) {
    const childNode = parent.childNodes[childNodeIdx];

    if (childName && !text && childName === childNode.localName) {
      return childNode;
    }

    if (text) {
      const childText = extractNodeText(childNode);

      if (!childText) {
        continue;
      }

      if (childName && childName === childNode.localName && text === childText) {
        return childNode;
      }

      if (!childName && text === childText) {
        return childNode;
      }
    }
  }

  return null;
}

function extractNodeText(node) {
  return !node || !node.firstChild || !_appiumSupport.util.hasValue(node.firstChild.nodeValue) ? null : node.firstChild.nodeValue;
}

class ChromedriverStorageClient {
  constructor(args = {}) {
    const {
      chromedriverDir = (0, _utils.getChromedriverDir)(),
      timeout = TIMEOUT_MS
    } = args;
    this.chromedriverDir = chromedriverDir;
    this.timeout = timeout;
    this.mapping = {};
  }

  parseNotes(content) {
    const result = {};
    const versionMatch = /^\s*[-]+ChromeDriver[\D]+([\d.]+)/im.exec(content);

    if (versionMatch) {
      result.version = versionMatch[1];
    }

    const minBrowserVersionMatch = /^\s*Supports Chrome[\D]+(\d+)/im.exec(content);

    if (minBrowserVersionMatch) {
      result.minBrowserVersion = minBrowserVersionMatch[1];
    }

    return result;
  }

  async retrieveAdditionalDriverInfo(driverKey, notesUrl, infoDict) {
    const response = await (0, _requestPromise.default)({
      url: notesUrl,
      method: 'GET',
      headers: {
        'user-agent': 'appium',
        accept: '*/*'
      },
      resolveWithFullResponse: true,
      timeout: this.timeout
    });
    const {
      minBrowserVersion
    } = this.parseNotes(response.body);

    if (!minBrowserVersion) {
      log.debug(`The driver '${driverKey}' does not contain valid release notes at ${notesUrl}. ` + `Skipping it`);
      return;
    }

    infoDict.minBrowserVersion = minBrowserVersion;
  }

  async parseStorageXml(doc, shouldParseNotes = true) {
    const driverNodes = _xpath.default.select(`//*[local-name(.)='Contents']`, doc);

    log.debug(`Parsed ${driverNodes.length} entries from storage XML`);

    if (_lodash.default.isEmpty(driverNodes)) {
      return;
    }

    const promises = [];

    for (const driverNode of driverNodes) {
      const key = extractNodeText(findChildNode(driverNode, 'Key'));

      if (!_lodash.default.includes(key, '/chromedriver_')) {
        continue;
      }

      log.debug(`Processing chromedriver entry '${key}'`);
      const etag = extractNodeText(findChildNode(driverNode, 'ETag'));

      if (!etag) {
        log.debug(`The entry '${key}' does not contain the checksum. Skipping it`);
        continue;
      }

      const cdInfo = {
        url: `${STORAGE_URL}/${key}`,
        etag: _lodash.default.trim(etag, '"'),
        version: _lodash.default.first(key.split('/'))
      };
      this.mapping[key] = cdInfo;
      const notesPath = `${cdInfo.version}/notes.txt`;
      const isNotesPresent = !!driverNodes.reduce((acc, node) => acc || findChildNode(node, 'Key', notesPath), false);

      if (!isNotesPresent) {
        cdInfo.minBrowserVersion = null;

        if (shouldParseNotes) {
          log.info(`The entry '${key}' does not contain any notes. Skipping it`);
        }

        continue;
      } else if (!shouldParseNotes) {
        continue;
      }

      promises.push(this.retrieveAdditionalDriverInfo(key, `${STORAGE_URL}/${notesPath}`, cdInfo));

      if (promises.length % MAX_PARALLEL_DOWNLOADS === 0) {
        await _bluebird.default.all(promises);
      }
    }

    await _bluebird.default.all(promises);
    log.info(`The total count of entries in the mapping: ${_lodash.default.size(this.mapping)}`);
  }

  async retrieveMapping(shouldParseNotes = true) {
    const response = await (0, _requestPromise.default)({
      url: STORAGE_URL,
      method: 'GET',
      headers: {
        'user-agent': 'appium',
        accept: 'application/xml, */*'
      },
      resolveWithFullResponse: true,
      timeout: this.timeout
    });
    const doc = new _xmldom.DOMParser().parseFromString(response.body);
    await this.parseStorageXml(doc, shouldParseNotes);
    return _lodash.default.cloneDeep(this.mapping);
  }

  async unzipDriver(src, dst) {
    const tmpRoot = await _appiumSupport.tempDir.openDir();

    try {
      await _appiumSupport.zip.extractAllTo(src, tmpRoot);
      const chromedriverPath = await _appiumSupport.fs.walkDir(tmpRoot, true, (itemPath, isDirectory) => !isDirectory && _lodash.default.toLower(_path.default.parse(itemPath).name) === 'chromedriver');

      if (!chromedriverPath) {
        throw new Error('The archive was unzipped properly, but we could not find any chromedriver executable');
      }

      log.debug(`Moving the extracted '${_path.default.basename(chromedriverPath)}' to '${dst}'`);
      await _appiumSupport.fs.mv(chromedriverPath, dst, {
        mkdirp: true
      });
    } finally {
      await _appiumSupport.fs.rimraf(tmpRoot);
    }
  }

  selectMatchingDrivers(osInfo, opts = {}) {
    const {
      minBrowserVersion,
      versions = []
    } = opts;

    let driversToSync = _lodash.default.keys(this.mapping);

    if (!_lodash.default.isEmpty(versions)) {
      log.debug(`Selecting chromedrivers whose versions match to ${versions}`);
      driversToSync = driversToSync.filter(cdName => versions.includes(`${this.mapping[cdName].version}`));
      log.debug(`Got ${driversToSync.length} item${driversToSync.length === 1 ? '' : 's'}`);

      if (_lodash.default.isEmpty(driversToSync)) {
        return [];
      }
    }

    if (!isNaN(minBrowserVersion)) {
      const minBrowserVersionInt = parseInt(minBrowserVersion, 10);
      log.debug(`Selecting chromedrivers whose minimum supported browser version matches to ${minBrowserVersionInt}`);
      let closestMatchedVersionNumber = 0;

      for (const cdName of driversToSync) {
        const currentMinBrowserVersion = parseInt(this.mapping[cdName].minBrowserVersion, 10);

        if (!isNaN(currentMinBrowserVersion) && currentMinBrowserVersion <= minBrowserVersionInt && closestMatchedVersionNumber < currentMinBrowserVersion) {
          closestMatchedVersionNumber = currentMinBrowserVersion;
        }
      }

      driversToSync = driversToSync.filter(cdName => `${this.mapping[cdName].minBrowserVersion}` === `${closestMatchedVersionNumber > 0 ? closestMatchedVersionNumber : minBrowserVersionInt}`);
      log.debug(`Got ${driversToSync.length} item${driversToSync.length === 1 ? '' : 's'}`);

      if (_lodash.default.isEmpty(driversToSync)) {
        return [];
      }

      log.debug(`Will select candidate driver${driversToSync.length === 1 ? '' : 's'} ` + `versioned as '${_lodash.default.uniq(driversToSync.map(cdName => this.mapping[cdName].version))}'`);
    }

    if (!_lodash.default.isEmpty(osInfo)) {
      let {
        name,
        arch
      } = osInfo;

      if (arch === '64' && !driversToSync.some(cdName => cdName.includes(`_${name}64`))) {
        arch = '32';
      }

      log.debug(`Selecting chromedrivers whose platform matches to ${name}${arch}`);
      driversToSync = driversToSync.filter(cdName => cdName.includes(`_${name}${arch}`));
      log.debug(`Got ${driversToSync.length} item${driversToSync.length === 1 ? '' : 's'}`);
    }

    return driversToSync;
  }

  async retrieveDriver(index, driverKey, archivesRoot, isStrict = false) {
    const {
      url,
      etag,
      version
    } = this.mapping[driverKey];

    const archivePath = _path.default.resolve(archivesRoot, `${index}.zip`);

    log.debug(`Retrieving '${url}' to '${archivePath}'`);

    try {
      await new _bluebird.default((resolve, reject) => {
        (0, _request.default)(url).on('error', reject).on('response', res => {
          if (res.statusCode >= 400) {
            return reject(`Error downloading chromedriver at ${url}: ${res.statusCode}`);
          }
        }).pipe(_appiumSupport.fs.createWriteStream(archivePath)).on('close', resolve);
      });
    } catch (e) {
      const msg = `Cannot download chromedriver archive. Original error: ${e.message}`;

      if (isStrict) {
        throw new Error(msg);
      }

      log.error(msg);
      return false;
    }

    if (!(await isCrcOk(archivePath, etag))) {
      const msg = `The checksum for the downloaded chromedriver '${driverKey}' did not match`;

      if (isStrict) {
        throw new Error(msg);
      }

      log.error(msg);
      return false;
    }

    const fileName = `${_path.default.parse(url).name}_v${version}` + (_appiumSupport.system.isWindows() ? '.exe' : '');

    const targetPath = _path.default.resolve(this.chromedriverDir, fileName);

    try {
      await this.unzipDriver(archivePath, targetPath);
    } catch (e) {
      if (isStrict) {
        throw e;
      }

      log.error(e.message);
      return false;
    }

    return true;
  }

  async syncDrivers(opts = {}) {
    if (_lodash.default.isEmpty(this.mapping)) {
      await this.retrieveMapping(!!opts.minBrowserVersion);
    }

    if (_lodash.default.isEmpty(this.mapping)) {
      throw new Error('Cannot retrieve chromedrivers mapping from Google storage');
    }

    const driversToSync = this.selectMatchingDrivers((await getOsInfo()), opts);

    if (_lodash.default.isEmpty(driversToSync)) {
      log.debug(`There are no drivers to sync. Exiting`);
      return [];
    }

    log.debug(`Got ${driversToSync.length} driver${driversToSync.length === 1 ? '' : 's'} to sync: ` + JSON.stringify(driversToSync, null, 2));
    const synchronizedDrivers = [];
    const promises = [];
    const archivesRoot = await _appiumSupport.tempDir.openDir();

    try {
      for (const [idx, driverKey] of driversToSync.entries()) {
        promises.push((async () => {
          if (await this.retrieveDriver(idx, driverKey, archivesRoot, !_lodash.default.isEmpty(opts))) {
            synchronizedDrivers.push(driverKey);
          }
        })());

        if (promises.length % MAX_PARALLEL_DOWNLOADS === 0) {
          await _bluebird.default.all(promises);
        }
      }

      await _bluebird.default.all(promises);
    } finally {
      await _appiumSupport.fs.rimraf(archivesRoot);
    }

    if (!_lodash.default.isEmpty(synchronizedDrivers)) {
      log.info(`Successfully synchronized ${synchronizedDrivers.length} ` + `chromedriver${synchronizedDrivers.length === 1 ? '' : 's'}`);
    } else {
      log.info(`No chromedrivers were synchronized`);
    }

    return synchronizedDrivers;
  }

}

var _default = ChromedriverStorageClient;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zdG9yYWdlLWNsaWVudC5qcyJdLCJuYW1lcyI6WyJTVE9SQUdFX1VSTCIsIlRJTUVPVVRfTVMiLCJNQVhfUEFSQUxMRUxfRE9XTkxPQURTIiwibG9nIiwibG9nZ2VyIiwiZ2V0TG9nZ2VyIiwiZ2V0T3NJbmZvIiwibmFtZSIsInN5c3RlbSIsImlzV2luZG93cyIsImlzTWFjIiwiYXJjaCIsImlzQ3JjT2siLCJzcmMiLCJjaGVja3N1bSIsIm1kNSIsImZzIiwiaGFzaCIsIl8iLCJ0b0xvd2VyIiwiZmluZENoaWxkTm9kZSIsInBhcmVudCIsImNoaWxkTmFtZSIsInRleHQiLCJoYXNDaGlsZE5vZGVzIiwiY2hpbGROb2RlSWR4IiwiY2hpbGROb2RlcyIsImxlbmd0aCIsImNoaWxkTm9kZSIsImxvY2FsTmFtZSIsImNoaWxkVGV4dCIsImV4dHJhY3ROb2RlVGV4dCIsIm5vZGUiLCJmaXJzdENoaWxkIiwidXRpbCIsImhhc1ZhbHVlIiwibm9kZVZhbHVlIiwiQ2hyb21lZHJpdmVyU3RvcmFnZUNsaWVudCIsImNvbnN0cnVjdG9yIiwiYXJncyIsImNocm9tZWRyaXZlckRpciIsInRpbWVvdXQiLCJtYXBwaW5nIiwicGFyc2VOb3RlcyIsImNvbnRlbnQiLCJyZXN1bHQiLCJ2ZXJzaW9uTWF0Y2giLCJleGVjIiwidmVyc2lvbiIsIm1pbkJyb3dzZXJWZXJzaW9uTWF0Y2giLCJtaW5Ccm93c2VyVmVyc2lvbiIsInJldHJpZXZlQWRkaXRpb25hbERyaXZlckluZm8iLCJkcml2ZXJLZXkiLCJub3Rlc1VybCIsImluZm9EaWN0IiwicmVzcG9uc2UiLCJ1cmwiLCJtZXRob2QiLCJoZWFkZXJzIiwiYWNjZXB0IiwicmVzb2x2ZVdpdGhGdWxsUmVzcG9uc2UiLCJib2R5IiwiZGVidWciLCJwYXJzZVN0b3JhZ2VYbWwiLCJkb2MiLCJzaG91bGRQYXJzZU5vdGVzIiwiZHJpdmVyTm9kZXMiLCJ4cGF0aCIsInNlbGVjdCIsImlzRW1wdHkiLCJwcm9taXNlcyIsImRyaXZlck5vZGUiLCJrZXkiLCJpbmNsdWRlcyIsImV0YWciLCJjZEluZm8iLCJ0cmltIiwiZmlyc3QiLCJzcGxpdCIsIm5vdGVzUGF0aCIsImlzTm90ZXNQcmVzZW50IiwicmVkdWNlIiwiYWNjIiwiaW5mbyIsInB1c2giLCJCIiwiYWxsIiwic2l6ZSIsInJldHJpZXZlTWFwcGluZyIsIkRPTVBhcnNlciIsInBhcnNlRnJvbVN0cmluZyIsImNsb25lRGVlcCIsInVuemlwRHJpdmVyIiwiZHN0IiwidG1wUm9vdCIsInRlbXBEaXIiLCJvcGVuRGlyIiwiemlwIiwiZXh0cmFjdEFsbFRvIiwiY2hyb21lZHJpdmVyUGF0aCIsIndhbGtEaXIiLCJpdGVtUGF0aCIsImlzRGlyZWN0b3J5IiwicGF0aCIsInBhcnNlIiwiRXJyb3IiLCJiYXNlbmFtZSIsIm12IiwibWtkaXJwIiwicmltcmFmIiwic2VsZWN0TWF0Y2hpbmdEcml2ZXJzIiwib3NJbmZvIiwib3B0cyIsInZlcnNpb25zIiwiZHJpdmVyc1RvU3luYyIsImtleXMiLCJmaWx0ZXIiLCJjZE5hbWUiLCJpc05hTiIsIm1pbkJyb3dzZXJWZXJzaW9uSW50IiwicGFyc2VJbnQiLCJjbG9zZXN0TWF0Y2hlZFZlcnNpb25OdW1iZXIiLCJjdXJyZW50TWluQnJvd3NlclZlcnNpb24iLCJ1bmlxIiwibWFwIiwic29tZSIsInJldHJpZXZlRHJpdmVyIiwiaW5kZXgiLCJhcmNoaXZlc1Jvb3QiLCJpc1N0cmljdCIsImFyY2hpdmVQYXRoIiwicmVzb2x2ZSIsInJlamVjdCIsIm9uIiwicmVzIiwic3RhdHVzQ29kZSIsInBpcGUiLCJjcmVhdGVXcml0ZVN0cmVhbSIsImUiLCJtc2ciLCJtZXNzYWdlIiwiZXJyb3IiLCJmaWxlTmFtZSIsInRhcmdldFBhdGgiLCJzeW5jRHJpdmVycyIsIkpTT04iLCJzdHJpbmdpZnkiLCJzeW5jaHJvbml6ZWREcml2ZXJzIiwiaWR4IiwiZW50cmllcyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFD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QU1oQixRQUFOLENBQU47QUFDRCxLQWJELFNBYVU7QUFDUixZQUFNdEQsa0JBQUc2RixNQUFILENBQVVtQixZQUFWLENBQU47QUFDRDs7QUFDRCxRQUFJLENBQUM5RyxnQkFBRW1ELE9BQUYsQ0FBVThFLG1CQUFWLENBQUwsRUFBcUM7QUFDbkNoSixNQUFBQSxHQUFHLENBQUNnRixJQUFKLENBQVUsNkJBQTRCZ0UsbUJBQW1CLENBQUN4SCxNQUFPLEdBQXhELEdBQ04sZUFBY3dILG1CQUFtQixDQUFDeEgsTUFBcEIsS0FBK0IsQ0FBL0IsR0FBbUMsRUFBbkMsR0FBd0MsR0FBSSxFQUQ3RDtBQUVELEtBSEQsTUFHTztBQUNMeEIsTUFBQUEsR0FBRyxDQUFDZ0YsSUFBSixDQUFVLG9DQUFWO0FBQ0Q7O0FBQ0QsV0FBT2dFLG1CQUFQO0FBQ0Q7O0FBMVk2Qjs7ZUE2WWpCOUcseUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBnZXRDaHJvbWVkcml2ZXJEaXIgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgcmVxdWVzdFByb21pc2UgZnJvbSAncmVxdWVzdC1wcm9taXNlJztcbmltcG9ydCByZXF1ZXN0IGZyb20gJ3JlcXVlc3QnO1xuaW1wb3J0IHhwYXRoIGZyb20gJ3hwYXRoJztcbmltcG9ydCB7IERPTVBhcnNlciB9IGZyb20gJ3htbGRvbSc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IHN5c3RlbSwgZnMsIGxvZ2dlciwgdGVtcERpciwgemlwLCB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuXG5cbmNvbnN0IFNUT1JBR0VfVVJMID0gJ2h0dHBzOi8vY2hyb21lZHJpdmVyLnN0b3JhZ2UuZ29vZ2xlYXBpcy5jb20nO1xuY29uc3QgVElNRU9VVF9NUyA9IDE1MDAwO1xuY29uc3QgTUFYX1BBUkFMTEVMX0RPV05MT0FEUyA9IDU7XG5cbmNvbnN0IGxvZyA9IGxvZ2dlci5nZXRMb2dnZXIoJ0Nocm9tZWRyaXZlclN0b3JhZ2VDbGllbnQnKTtcblxuXG5hc3luYyBmdW5jdGlvbiBnZXRPc0luZm8gKCkge1xuICBsZXQgbmFtZSA9ICdsaW51eCc7XG4gIGlmIChzeXN0ZW0uaXNXaW5kb3dzKCkpIHtcbiAgICBuYW1lID0gJ3dpbic7XG4gIH0gZWxzZSBpZiAoc3lzdGVtLmlzTWFjKCkpIHtcbiAgICBuYW1lID0gJ21hYyc7XG4gIH1cbiAgcmV0dXJuIHtcbiAgICBuYW1lLFxuICAgIGFyY2g6IGF3YWl0IHN5c3RlbS5hcmNoKCksXG4gIH07XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGlzQ3JjT2sgKHNyYywgY2hlY2tzdW0pIHtcbiAgY29uc3QgbWQ1ID0gYXdhaXQgZnMuaGFzaChzcmMsICdtZDUnKTtcbiAgcmV0dXJuIF8udG9Mb3dlcihtZDUpID09PSBfLnRvTG93ZXIoY2hlY2tzdW0pO1xufVxuXG5mdW5jdGlvbiBmaW5kQ2hpbGROb2RlIChwYXJlbnQsIGNoaWxkTmFtZSA9IG51bGwsIHRleHQgPSBudWxsKSB7XG4gIGlmICghY2hpbGROYW1lICYmICF0ZXh0KSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbiAgaWYgKCFwYXJlbnQuaGFzQ2hpbGROb2RlcygpKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBmb3IgKGxldCBjaGlsZE5vZGVJZHggPSAwOyBjaGlsZE5vZGVJZHggPCBwYXJlbnQuY2hpbGROb2Rlcy5sZW5ndGg7IGNoaWxkTm9kZUlkeCsrKSB7XG4gICAgY29uc3QgY2hpbGROb2RlID0gcGFyZW50LmNoaWxkTm9kZXNbY2hpbGROb2RlSWR4XTtcbiAgICBpZiAoY2hpbGROYW1lICYmICF0ZXh0ICYmIGNoaWxkTmFtZSA9PT0gY2hpbGROb2RlLmxvY2FsTmFtZSkge1xuICAgICAgcmV0dXJuIGNoaWxkTm9kZTtcbiAgICB9XG4gICAgaWYgKHRleHQpIHtcbiAgICAgIGNvbnN0IGNoaWxkVGV4dCA9IGV4dHJhY3ROb2RlVGV4dChjaGlsZE5vZGUpO1xuICAgICAgaWYgKCFjaGlsZFRleHQpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBpZiAoY2hpbGROYW1lICYmIGNoaWxkTmFtZSA9PT0gY2hpbGROb2RlLmxvY2FsTmFtZSAmJiB0ZXh0ID09PSBjaGlsZFRleHQpIHtcbiAgICAgICAgcmV0dXJuIGNoaWxkTm9kZTtcbiAgICAgIH1cbiAgICAgIGlmICghY2hpbGROYW1lICYmIHRleHQgPT09IGNoaWxkVGV4dCkge1xuICAgICAgICByZXR1cm4gY2hpbGROb2RlO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICByZXR1cm4gbnVsbDtcbn1cblxuZnVuY3Rpb24gZXh0cmFjdE5vZGVUZXh0IChub2RlKSB7XG4gIHJldHVybiAoIW5vZGUgfHwgIW5vZGUuZmlyc3RDaGlsZCB8fCAhdXRpbC5oYXNWYWx1ZShub2RlLmZpcnN0Q2hpbGQubm9kZVZhbHVlKSlcbiAgICA/IG51bGxcbiAgICA6IG5vZGUuZmlyc3RDaGlsZC5ub2RlVmFsdWU7XG59XG5cblxuY2xhc3MgQ2hyb21lZHJpdmVyU3RvcmFnZUNsaWVudCB7XG4gIGNvbnN0cnVjdG9yIChhcmdzID0ge30pIHtcbiAgICBjb25zdCB7XG4gICAgICBjaHJvbWVkcml2ZXJEaXIgPSBnZXRDaHJvbWVkcml2ZXJEaXIoKSxcbiAgICAgIHRpbWVvdXQgPSBUSU1FT1VUX01TLFxuICAgIH0gPSBhcmdzO1xuICAgIHRoaXMuY2hyb21lZHJpdmVyRGlyID0gY2hyb21lZHJpdmVyRGlyO1xuICAgIHRoaXMudGltZW91dCA9IHRpbWVvdXQ7XG4gICAgdGhpcy5tYXBwaW5nID0ge307XG4gIH1cblxuICAvKipcbiAgICogQHR5cGVkZWYge09iamVjdH0gQWRkaXRpb25hbERyaXZlckRldGFpbHNcbiAgICogQHByb3BlcnR5IHs/c3RyaW5nfSB2ZXJzaW9uIC0gQ2hyb21lZHJpdmVyIHZlcnNpb25cbiAgICogb3IgYG51bGxgIGlmIGl0IGNhbm5vdCBiZSBmb3VuZFxuICAgKiBAcHJvcGVydHkgez9zdHJpbmd9IG1pbkJyb3dzZXJWZXJzaW9uIC0gVGhlIG1pbmltdW0gYnJvd3NlciB2ZXJzaW9uXG4gICAqIHN1cHBvcnRlZCBieSBjaHJvbWVkcml2ZXIgb3IgYG51bGxgIGlmIGl0IGNhbm5vdCBiZSBmb3VuZFxuICAgKi9cblxuICAvKipcbiAgICogR2V0cyBhZGRpdGlvbmFsIGNocm9tZWRyaXZlciBkZXRhaWxzIGZyb20gY2hyb21lZHJpdmVyXG4gICAqIHJlbGVhc2Ugbm90ZXNcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGNvbnRlbnQgLSBSZWxlYXNlIG5vdGVzIG9mIHRoZSBjb3JyZXNwb25kaW5nIGNocm9tZWRyaXZlclxuICAgKiBAcmV0dXJucyB7QWRkaXRpb25hbERyaXZlckRldGFpbHN9XG4gICAqL1xuICBwYXJzZU5vdGVzIChjb250ZW50KSB7XG4gICAgY29uc3QgcmVzdWx0ID0ge307XG4gICAgY29uc3QgdmVyc2lvbk1hdGNoID0gL15cXHMqWy1dK0Nocm9tZURyaXZlcltcXERdKyhbXFxkLl0rKS9pbS5leGVjKGNvbnRlbnQpO1xuICAgIGlmICh2ZXJzaW9uTWF0Y2gpIHtcbiAgICAgIHJlc3VsdC52ZXJzaW9uID0gdmVyc2lvbk1hdGNoWzFdO1xuICAgIH1cbiAgICBjb25zdCBtaW5Ccm93c2VyVmVyc2lvbk1hdGNoID0gL15cXHMqU3VwcG9ydHMgQ2hyb21lW1xcRF0rKFxcZCspL2ltLmV4ZWMoY29udGVudCk7XG4gICAgaWYgKG1pbkJyb3dzZXJWZXJzaW9uTWF0Y2gpIHtcbiAgICAgIHJlc3VsdC5taW5Ccm93c2VyVmVyc2lvbiA9IG1pbkJyb3dzZXJWZXJzaW9uTWF0Y2hbMV07XG4gICAgfVxuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICAvKipcbiAgICogRG93bmxvYWRzIGNocm9tZWRyaXZlciByZWxlYXNlIG5vdGVzIGFuZCBwdXRzIHRoZW1cbiAgICogaW50byB0aGUgZGljdGlvbmFyeSBhcmd1bWVudFxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gZHJpdmVyS2V5IC0gRHJpdmVyIHZlcnNpb24gcGx1cyBhcmNoaXZlIG5hbWVcbiAgICogQHBhcmFtIHtzdHJpbmd9IG5vdGVzVXJsIC0gVGhlIFVSTCBvZiBjaHJvbWVkcml2ZXIgbm90ZXNcbiAgICogQHBhcmFtIHtPYmplY3R9IGluZm9EaWN0IC0gVGhlIGRpY3Rpb25hcnkgY29udGFpbmluZyBkcml2ZXIgaW5mby5cbiAgICogVGhlIG1ldGhvZCBjYWxsIG11dGF0ZXMgYnkgbWVyZ2luZyBgQWRkaXRpb25hbERyaXZlckRldGFpbHNgXG4gICAqIEB0aHJvd3Mge0Vycm9yfSBpZiB0aGUgcmVsZWFzZSBub3RlcyBjYW5ub3QgYmUgZG93bmxvYWRlZFxuICAgKi9cbiAgYXN5bmMgcmV0cmlldmVBZGRpdGlvbmFsRHJpdmVySW5mbyAoZHJpdmVyS2V5LCBub3Rlc1VybCwgaW5mb0RpY3QpIHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHJlcXVlc3RQcm9taXNlKHtcbiAgICAgIHVybDogbm90ZXNVcmwsXG4gICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgaGVhZGVyczoge1xuICAgICAgICAndXNlci1hZ2VudCc6ICdhcHBpdW0nLFxuICAgICAgICBhY2NlcHQ6ICcqLyonLFxuICAgICAgfSxcbiAgICAgIHJlc29sdmVXaXRoRnVsbFJlc3BvbnNlOiB0cnVlLFxuICAgICAgdGltZW91dDogdGhpcy50aW1lb3V0LFxuICAgIH0pO1xuICAgIGNvbnN0IHsgbWluQnJvd3NlclZlcnNpb24gfSA9IHRoaXMucGFyc2VOb3RlcyhyZXNwb25zZS5ib2R5KTtcbiAgICBpZiAoIW1pbkJyb3dzZXJWZXJzaW9uKSB7XG4gICAgICBsb2cuZGVidWcoYFRoZSBkcml2ZXIgJyR7ZHJpdmVyS2V5fScgZG9lcyBub3QgY29udGFpbiB2YWxpZCByZWxlYXNlIG5vdGVzIGF0ICR7bm90ZXNVcmx9LiBgICtcbiAgICAgICAgYFNraXBwaW5nIGl0YCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIGluZm9EaWN0Lm1pbkJyb3dzZXJWZXJzaW9uID0gbWluQnJvd3NlclZlcnNpb247XG4gIH1cblxuICAvKipcbiAgICogUGFyc2VzIGNocm9tZWRyaXZlciBzdG9yYWdlIFhNTCBhbmQgc3RvcmVzXG4gICAqIHRoZSBwYXJzZWQgcmVzdWx0cyBpbnRvIGB0aGlzLm1hcHBpbmdgXG4gICAqXG4gICAqIEBwYXJhbSB7RE9NRG9jdW1lbnR9IGRvYyAtIFRoZSBET00gcmVwcmVzZW50YXRpb25cbiAgICogb2YgdGhlIGNocm9tZWRyaXZlciBzdG9yYWdlIFhNTFxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IHNob3VsZFBhcnNlTm90ZXMgW3RydWVdIC0gSWYgc2V0IHRvIGB0cnVlYFxuICAgKiB0aGVuIGFkZGl0aW9uYWwgZHJpdmVycyBpbmZvcm1hdGlvbiBpcyBnb2luZyB0byBiZSBwYXJzZWRcbiAgICogYW5kIGFzc2lnbmVkIHRvIGB0aGlzLm1hcHBpbmdgXG4gICAqL1xuICBhc3luYyBwYXJzZVN0b3JhZ2VYbWwgKGRvYywgc2hvdWxkUGFyc2VOb3RlcyA9IHRydWUpIHtcbiAgICBjb25zdCBkcml2ZXJOb2RlcyA9IHhwYXRoLnNlbGVjdChgLy8qW2xvY2FsLW5hbWUoLik9J0NvbnRlbnRzJ11gLCBkb2MpO1xuICAgIGxvZy5kZWJ1ZyhgUGFyc2VkICR7ZHJpdmVyTm9kZXMubGVuZ3RofSBlbnRyaWVzIGZyb20gc3RvcmFnZSBYTUxgKTtcbiAgICBpZiAoXy5pc0VtcHR5KGRyaXZlck5vZGVzKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHByb21pc2VzID0gW107XG4gICAgZm9yIChjb25zdCBkcml2ZXJOb2RlIG9mIGRyaXZlck5vZGVzKSB7XG4gICAgICBjb25zdCBrZXkgPSBleHRyYWN0Tm9kZVRleHQoZmluZENoaWxkTm9kZShkcml2ZXJOb2RlLCAnS2V5JykpO1xuICAgICAgaWYgKCFfLmluY2x1ZGVzKGtleSwgJy9jaHJvbWVkcml2ZXJfJykpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGxvZy5kZWJ1ZyhgUHJvY2Vzc2luZyBjaHJvbWVkcml2ZXIgZW50cnkgJyR7a2V5fSdgKTtcbiAgICAgIGNvbnN0IGV0YWcgPSBleHRyYWN0Tm9kZVRleHQoZmluZENoaWxkTm9kZShkcml2ZXJOb2RlLCAnRVRhZycpKTtcbiAgICAgIGlmICghZXRhZykge1xuICAgICAgICBsb2cuZGVidWcoYFRoZSBlbnRyeSAnJHtrZXl9JyBkb2VzIG5vdCBjb250YWluIHRoZSBjaGVja3N1bS4gU2tpcHBpbmcgaXRgKTtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNkSW5mbyA9IHtcbiAgICAgICAgdXJsOiBgJHtTVE9SQUdFX1VSTH0vJHtrZXl9YCxcbiAgICAgICAgZXRhZzogXy50cmltKGV0YWcsICdcIicpLFxuICAgICAgICB2ZXJzaW9uOiBfLmZpcnN0KGtleS5zcGxpdCgnLycpKSxcbiAgICAgIH07XG4gICAgICB0aGlzLm1hcHBpbmdba2V5XSA9IGNkSW5mbztcblxuICAgICAgY29uc3Qgbm90ZXNQYXRoID0gYCR7Y2RJbmZvLnZlcnNpb259L25vdGVzLnR4dGA7XG4gICAgICBjb25zdCBpc05vdGVzUHJlc2VudCA9ICEhZHJpdmVyTm9kZXNcbiAgICAgICAgLnJlZHVjZSgoYWNjLCBub2RlKSA9PiBhY2MgfHwgZmluZENoaWxkTm9kZShub2RlLCAnS2V5Jywgbm90ZXNQYXRoKSwgZmFsc2UpO1xuICAgICAgaWYgKCFpc05vdGVzUHJlc2VudCkge1xuICAgICAgICBjZEluZm8ubWluQnJvd3NlclZlcnNpb24gPSBudWxsO1xuICAgICAgICBpZiAoc2hvdWxkUGFyc2VOb3Rlcykge1xuICAgICAgICAgIGxvZy5pbmZvKGBUaGUgZW50cnkgJyR7a2V5fScgZG9lcyBub3QgY29udGFpbiBhbnkgbm90ZXMuIFNraXBwaW5nIGl0YCk7XG4gICAgICAgIH1cbiAgICAgICAgY29udGludWU7XG4gICAgICB9IGVsc2UgaWYgKCFzaG91bGRQYXJzZU5vdGVzKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBwcm9taXNlcy5wdXNoKHRoaXMucmV0cmlldmVBZGRpdGlvbmFsRHJpdmVySW5mbyhrZXksIGAke1NUT1JBR0VfVVJMfS8ke25vdGVzUGF0aH1gLCBjZEluZm8pKTtcbiAgICAgIGlmIChwcm9taXNlcy5sZW5ndGggJSBNQVhfUEFSQUxMRUxfRE9XTkxPQURTID09PSAwKSB7XG4gICAgICAgIGF3YWl0IEIuYWxsKHByb21pc2VzKTtcbiAgICAgIH1cbiAgICB9XG4gICAgYXdhaXQgQi5hbGwocHJvbWlzZXMpO1xuICAgIGxvZy5pbmZvKGBUaGUgdG90YWwgY291bnQgb2YgZW50cmllcyBpbiB0aGUgbWFwcGluZzogJHtfLnNpemUodGhpcy5tYXBwaW5nKX1gKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAdHlwZWRlZiB7T2JqZWN0fSBEcml2ZXJEZXRhaWxzXG4gICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSB1cmwgLSBUaGUgZnVsbCB1cmwgdG8gdGhlIGNvcnJlc3BvbmRpbmcgZHJpdmVyIGluXG4gICAqIHRoZSByZW1vdGUgc3RvcmFnZVxuICAgKiBAcHJvcGVydHkge3N0cmluZ30gZXRhZyAtIFRoZSBDUkMgb2YgdGhlIGRyaXZlciBhcmNoaXZlXG4gICAqIEBwcm9wZXJ0eSB7c3RyaW5nfSB2ZXJzaW9uIC0gQ2hyb21lZHJpdmVyIHZlcnNpb25cbiAgICovXG5cbiAgLyoqXG4gICAqIEB0eXBlZGVmIHtPYmplY3R9IENocm9tZWRyaXZlcnNNYXBwaW5nXG4gICAqIEBwcm9wZXJ0eSB7RHJpdmVyRGV0YWlsc30gLSBUaGUga2V5cyBhcmUgdW5pcXVlIGRyaXZlciBpZGVudGlmaWVyc1xuICAgKiAodmVyc2lvbi9hcmNoaXZlIG5hbWUpLiBUaGUgY29ycmVzcG9uZGluZyB2YWx1ZXMgaGF2ZSBgRHJpdmVyRGV0YWlsc2BcbiAgICogY29udGFpbmluZyBjaHJvbWVkcml2ZXIgZGV0YWlsc1xuICAgKi9cblxuICAvKipcbiAgICogUmV0cmlldmVzIGNocm9tZWRyaXZlciBtYXBwaW5nIGZyb20gdGhlIHN0b3JhZ2VcbiAgICpcbiAgICogQHBhcmFtIHtib29sZWFufSBzaG91bGRQYXJzZU5vdGVzIFt0cnVlXSAtIGlmIHNldCB0byBgdHJ1ZWBcbiAgICogdGhlbiBhZGRpdGlvbmFsIGNocm9tZWRyaXZlcnMgaW5mbyBpcyBnb2luZyB0byBiZSByZXRyaWV2ZWQgYW5kXG4gICAqIHBhcnNlZCBmcm9tIHJlbGVhc2Ugbm90ZXNcbiAgICogQHJldHVybnMge0Nocm9tZWRyaXZlcnNNYXBwaW5nfVxuICAgKi9cbiAgYXN5bmMgcmV0cmlldmVNYXBwaW5nIChzaG91bGRQYXJzZU5vdGVzID0gdHJ1ZSkge1xuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgcmVxdWVzdFByb21pc2Uoe1xuICAgICAgdXJsOiBTVE9SQUdFX1VSTCxcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICd1c2VyLWFnZW50JzogJ2FwcGl1bScsXG4gICAgICAgIGFjY2VwdDogJ2FwcGxpY2F0aW9uL3htbCwgKi8qJyxcbiAgICAgIH0sXG4gICAgICByZXNvbHZlV2l0aEZ1bGxSZXNwb25zZTogdHJ1ZSxcbiAgICAgIHRpbWVvdXQ6IHRoaXMudGltZW91dCxcbiAgICB9KTtcbiAgICBjb25zdCBkb2MgPSBuZXcgRE9NUGFyc2VyKCkucGFyc2VGcm9tU3RyaW5nKHJlc3BvbnNlLmJvZHkpO1xuICAgIGF3YWl0IHRoaXMucGFyc2VTdG9yYWdlWG1sKGRvYywgc2hvdWxkUGFyc2VOb3Rlcyk7XG4gICAgcmV0dXJuIF8uY2xvbmVEZWVwKHRoaXMubWFwcGluZyk7XG4gIH1cblxuICAvKipcbiAgICogRXh0cmFjdHMgZG93bmxvYWRlZCBjaHJvbWVkcml2ZXIgYXJjaGl2ZVxuICAgKiBpbnRvIHRoZSBnaXZlbiBkZXN0aW5hdGlvblxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gc3JjIC0gVGhlIHNvdXJjZSBhcmNoaXZlIHBhdGhcbiAgICogQHBhcmFtIHtzdHJpbmd9IGRzdCAtIFRoZSBkZXN0aW5hdGlvbiBjaHJvbWVkcml2ZXIgcGF0aFxuICAgKi9cbiAgYXN5bmMgdW56aXBEcml2ZXIgKHNyYywgZHN0KSB7XG4gICAgY29uc3QgdG1wUm9vdCA9IGF3YWl0IHRlbXBEaXIub3BlbkRpcigpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB6aXAuZXh0cmFjdEFsbFRvKHNyYywgdG1wUm9vdCk7XG4gICAgICBjb25zdCBjaHJvbWVkcml2ZXJQYXRoID0gYXdhaXQgZnMud2Fsa0Rpcih0bXBSb290LCB0cnVlLCAoaXRlbVBhdGgsIGlzRGlyZWN0b3J5KSA9PlxuICAgICAgICAhaXNEaXJlY3RvcnkgJiYgXy50b0xvd2VyKHBhdGgucGFyc2UoaXRlbVBhdGgpLm5hbWUpID09PSAnY2hyb21lZHJpdmVyJyk7XG4gICAgICBpZiAoIWNocm9tZWRyaXZlclBhdGgpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdUaGUgYXJjaGl2ZSB3YXMgdW56aXBwZWQgcHJvcGVybHksIGJ1dCB3ZSBjb3VsZCBub3QgZmluZCBhbnkgY2hyb21lZHJpdmVyIGV4ZWN1dGFibGUnKTtcbiAgICAgIH1cbiAgICAgIGxvZy5kZWJ1ZyhgTW92aW5nIHRoZSBleHRyYWN0ZWQgJyR7cGF0aC5iYXNlbmFtZShjaHJvbWVkcml2ZXJQYXRoKX0nIHRvICcke2RzdH0nYCk7XG4gICAgICBhd2FpdCBmcy5tdihjaHJvbWVkcml2ZXJQYXRoLCBkc3QsIHtcbiAgICAgICAgbWtkaXJwOiB0cnVlXG4gICAgICB9KTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgYXdhaXQgZnMucmltcmFmKHRtcFJvb3QpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAdHlwZWRlZiB7T2JqZWN0fSBPU0luZm9cbiAgICogQHByb3BlcnR5IHtzdHJpbmd9IG5hbWUgLSBUaGUgbmFtZSBvZiB0aGUgaG9zdCBPU1xuICAgKiBDYW4gYmUgZWl0aGVyIGBtYWNgLCBgd2luZG93c2Agb3IgYGxpbnV4YFxuICAgKiBAcHJvcGVydHkge3N0cmluZ30gYXJjaCAtIFRoZSBhcmNoaXRlY3R1cmUgb2YgdGhlIGhvc3QgT0QuXG4gICAqIENhbiBiZSBlaXRoZXIgYDMyYCBvciBgNjRgXG4gICAqL1xuXG4gIC8qKlxuICAgKiBGaWx0ZXJzIGB0aGlzLm1hcHBpbmdgIHRvIG9ubHkgc2VsZWN0IG1hdGNoaW5nXG4gICAqIGNocm9tZWRyaXZlciBlbnRyaWVzIGJ5IG9wZXJhdGluZyBzeXN0ZW0gaW5mb3JtYXRpb25cbiAgICogYW5kL29yIGFkZGl0aW9uYWwgc3luY2hyb25pemF0aW9uIG9wdGlvbnMgKGlmIHByb3ZpZGVkKVxuICAgKlxuICAgKiBAcGFyYW0ge09TSW5mb30gb3NJbmZvXG4gICAqIEBwYXJhbSB7P1N5bmNPcHRpb25zfSBvcHRzXG4gICAqIEByZXR1cm5zIHtBcnJheTxTdHJpbmc+fSBUaGUgbGlzdCBvZiBmaWx0ZXJlZCBjaHJvbWVkcml2ZXJcbiAgICogZW50cnkgbmFtZXMgKHZlcnNpb24vYXJjaGl2ZSBuYW1lKVxuICAgKi9cbiAgc2VsZWN0TWF0Y2hpbmdEcml2ZXJzIChvc0luZm8sIG9wdHMgPSB7fSkge1xuICAgIGNvbnN0IHtcbiAgICAgIG1pbkJyb3dzZXJWZXJzaW9uLFxuICAgICAgdmVyc2lvbnMgPSBbXSxcbiAgICB9ID0gb3B0cztcbiAgICBsZXQgZHJpdmVyc1RvU3luYyA9IF8ua2V5cyh0aGlzLm1hcHBpbmcpO1xuXG4gICAgaWYgKCFfLmlzRW1wdHkodmVyc2lvbnMpKSB7XG4gICAgICAvLyBIYW5kbGUgb25seSBzZWxlY3RlZCB2ZXJzaW9ucyBpZiByZXF1ZXN0ZWRcbiAgICAgIGxvZy5kZWJ1ZyhgU2VsZWN0aW5nIGNocm9tZWRyaXZlcnMgd2hvc2UgdmVyc2lvbnMgbWF0Y2ggdG8gJHt2ZXJzaW9uc31gKTtcbiAgICAgIGRyaXZlcnNUb1N5bmMgPSBkcml2ZXJzVG9TeW5jXG4gICAgICAgIC5maWx0ZXIoKGNkTmFtZSkgPT4gdmVyc2lvbnMuaW5jbHVkZXMoYCR7dGhpcy5tYXBwaW5nW2NkTmFtZV0udmVyc2lvbn1gKSk7XG5cbiAgICAgIGxvZy5kZWJ1ZyhgR290ICR7ZHJpdmVyc1RvU3luYy5sZW5ndGh9IGl0ZW0ke2RyaXZlcnNUb1N5bmMubGVuZ3RoID09PSAxID8gJycgOiAncyd9YCk7XG4gICAgICBpZiAoXy5pc0VtcHR5KGRyaXZlcnNUb1N5bmMpKSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIWlzTmFOKG1pbkJyb3dzZXJWZXJzaW9uKSkge1xuICAgICAgLy8gT25seSBzZWxlY3QgZHJpdmVycyB0aGF0IHN1cHBvcnQgdGhlIGN1cnJlbnQgYnJvd3NlciB3aG9zZSBtYWpvciB2ZXJzaW9uIG51bWJlciBlcXVhbHMgdG8gYG1pbkJyb3dzZXJWZXJzaW9uYFxuICAgICAgY29uc3QgbWluQnJvd3NlclZlcnNpb25JbnQgPSBwYXJzZUludChtaW5Ccm93c2VyVmVyc2lvbiwgMTApO1xuICAgICAgbG9nLmRlYnVnKGBTZWxlY3RpbmcgY2hyb21lZHJpdmVycyB3aG9zZSBtaW5pbXVtIHN1cHBvcnRlZCBicm93c2VyIHZlcnNpb24gbWF0Y2hlcyB0byAke21pbkJyb3dzZXJWZXJzaW9uSW50fWApO1xuICAgICAgbGV0IGNsb3Nlc3RNYXRjaGVkVmVyc2lvbk51bWJlciA9IDA7XG4gICAgICAvLyBTZWxlY3QgdGhlIG5ld2VzdCBhdmFpbGFibGUgYW5kIGNvbXBhdGlibGUgY2hyb21lZHJpdmVyXG4gICAgICBmb3IgKGNvbnN0IGNkTmFtZSBvZiBkcml2ZXJzVG9TeW5jKSB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRNaW5Ccm93c2VyVmVyc2lvbiA9IHBhcnNlSW50KHRoaXMubWFwcGluZ1tjZE5hbWVdLm1pbkJyb3dzZXJWZXJzaW9uLCAxMCk7XG4gICAgICAgIGlmICghaXNOYU4oY3VycmVudE1pbkJyb3dzZXJWZXJzaW9uKVxuICAgICAgICAgICAgJiYgY3VycmVudE1pbkJyb3dzZXJWZXJzaW9uIDw9IG1pbkJyb3dzZXJWZXJzaW9uSW50XG4gICAgICAgICAgICAmJiBjbG9zZXN0TWF0Y2hlZFZlcnNpb25OdW1iZXIgPCBjdXJyZW50TWluQnJvd3NlclZlcnNpb24pIHtcbiAgICAgICAgICBjbG9zZXN0TWF0Y2hlZFZlcnNpb25OdW1iZXIgPSBjdXJyZW50TWluQnJvd3NlclZlcnNpb247XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGRyaXZlcnNUb1N5bmMgPSBkcml2ZXJzVG9TeW5jLmZpbHRlcigoY2ROYW1lKSA9PiBgJHt0aGlzLm1hcHBpbmdbY2ROYW1lXS5taW5Ccm93c2VyVmVyc2lvbn1gID09PVxuICAgICAgICBgJHtjbG9zZXN0TWF0Y2hlZFZlcnNpb25OdW1iZXIgPiAwID8gY2xvc2VzdE1hdGNoZWRWZXJzaW9uTnVtYmVyIDogbWluQnJvd3NlclZlcnNpb25JbnR9YCk7XG5cbiAgICAgIGxvZy5kZWJ1ZyhgR290ICR7ZHJpdmVyc1RvU3luYy5sZW5ndGh9IGl0ZW0ke2RyaXZlcnNUb1N5bmMubGVuZ3RoID09PSAxID8gJycgOiAncyd9YCk7XG4gICAgICBpZiAoXy5pc0VtcHR5KGRyaXZlcnNUb1N5bmMpKSB7XG4gICAgICAgIHJldHVybiBbXTtcbiAgICAgIH1cbiAgICAgIGxvZy5kZWJ1ZyhgV2lsbCBzZWxlY3QgY2FuZGlkYXRlIGRyaXZlciR7ZHJpdmVyc1RvU3luYy5sZW5ndGggPT09IDEgPyAnJyA6ICdzJ30gYCArXG4gICAgICAgIGB2ZXJzaW9uZWQgYXMgJyR7Xy51bmlxKGRyaXZlcnNUb1N5bmMubWFwKChjZE5hbWUpID0+IHRoaXMubWFwcGluZ1tjZE5hbWVdLnZlcnNpb24pKX0nYCk7XG4gICAgfVxuXG4gICAgaWYgKCFfLmlzRW1wdHkob3NJbmZvKSkge1xuICAgICAgLy8gRmlsdGVyIG91dCBkcml2ZXJzIGZvciB1bnN1cHBvcnRlZCBzeXN0ZW0gYXJjaGl0ZWN0dXJlc1xuICAgICAgbGV0IHtuYW1lLCBhcmNofSA9IG9zSW5mbztcbiAgICAgIGlmIChhcmNoID09PSAnNjQnICYmICFkcml2ZXJzVG9TeW5jLnNvbWUoKGNkTmFtZSkgPT4gY2ROYW1lLmluY2x1ZGVzKGBfJHtuYW1lfTY0YCkpKSB7XG4gICAgICAgIC8vIEZhbGwgYmFjayB0byB4ODYgYnVpbGQgaWYgeDY0IG9uZSBpcyBub3QgYXZhaWxhYmxlIGZvciB0aGUgZ2l2ZW4gT1NcbiAgICAgICAgYXJjaCA9ICczMic7XG4gICAgICB9XG4gICAgICBsb2cuZGVidWcoYFNlbGVjdGluZyBjaHJvbWVkcml2ZXJzIHdob3NlIHBsYXRmb3JtIG1hdGNoZXMgdG8gJHtuYW1lfSR7YXJjaH1gKTtcbiAgICAgIGRyaXZlcnNUb1N5bmMgPSBkcml2ZXJzVG9TeW5jLmZpbHRlcigoY2ROYW1lKSA9PiBjZE5hbWUuaW5jbHVkZXMoYF8ke25hbWV9JHthcmNofWApKTtcbiAgICAgIGxvZy5kZWJ1ZyhgR290ICR7ZHJpdmVyc1RvU3luYy5sZW5ndGh9IGl0ZW0ke2RyaXZlcnNUb1N5bmMubGVuZ3RoID09PSAxID8gJycgOiAncyd9YCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGRyaXZlcnNUb1N5bmM7XG4gIH1cblxuICAvKipcbiAgICogUmV0cmlldmVzIHRoZSBnaXZlbiBjaHJvbWVkcml2ZXIgZnJvbSB0aGUgc3RvcmFnZVxuICAgKiBhbmQgdW5wYWNrcyBpdCBpbnRvIGB0aGlzLmNocm9tZWRyaXZlckRpcmAgZm9sZGVyXG4gICAqXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBpbmRleCAtIFRoZSB1bmlxdWUgZHJpdmVyIGluZGV4XG4gICAqIEBwYXJhbSB7c3RyaW5nfSBkcml2ZXJLZXkgLSBUaGUgZHJpdmVyIGtleSBpbiBgdGhpcy5tYXBwaW5nYFxuICAgKiBAcGFyYW0ge3N0cmluZ30gYXJjaGl2ZXNSb290IC0gVGhlIHRlbXBvcmFyeSBmb2xkZXIgcGF0aCB0byBleHRyYWN0XG4gICAqIGRvd25sb2FkZWQgYXJjaGl2ZXMgdG9cbiAgICogQHBhcmFtIHtib29sZWFufSBpc1N0cmljdCBbdHJ1ZV0gLSBXaGV0aGVyIHRvIHRocm93IGFuIGVycm9yIChgdHJ1ZWApXG4gICAqIG9yIHJldHVybiBhIGJvb2xlYW4gcmVzdWx0IGlmIHRoZSBkcml2ZXIgcmV0cmlldmFsIHByb2Nlc3MgZmFpbHNcbiAgICogQHRocm93cyB7RXJyb3J9IGlmIHRoZXJlIHdhcyBhIGZhaWx1cmUgd2hpbGUgcmV0cmlldmluZyB0aGUgZHJpdmVyXG4gICAqIGFuZCBgaXNTdHJpY3RgIGlzIHNldCB0byBgdHJ1ZWBcbiAgICogQHJldHVybnMge2Jvb2xlYW59IGlmIGB0cnVlYCB0aGVuIHRoZSBjaHJvbWVkcml2ZXIgaXMgc3VjY2Vzc2Z1bGx5XG4gICAqIGRvd25sb2FkZWQgYW5kIGV4dHJhY3RlZFxuICAgKi9cbiAgYXN5bmMgcmV0cmlldmVEcml2ZXIgKGluZGV4LCBkcml2ZXJLZXksIGFyY2hpdmVzUm9vdCwgaXNTdHJpY3QgPSBmYWxzZSkge1xuICAgIGNvbnN0IHsgdXJsLCBldGFnLCB2ZXJzaW9uIH0gPSB0aGlzLm1hcHBpbmdbZHJpdmVyS2V5XTtcbiAgICBjb25zdCBhcmNoaXZlUGF0aCA9IHBhdGgucmVzb2x2ZShhcmNoaXZlc1Jvb3QsIGAke2luZGV4fS56aXBgKTtcbiAgICBsb2cuZGVidWcoYFJldHJpZXZpbmcgJyR7dXJsfScgdG8gJyR7YXJjaGl2ZVBhdGh9J2ApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgIHJlcXVlc3QodXJsKVxuICAgICAgICAgIC5vbignZXJyb3InLCByZWplY3QpXG4gICAgICAgICAgLm9uKCdyZXNwb25zZScsIChyZXMpID0+IHtcbiAgICAgICAgICAgIC8vIGhhbmRsZSByZXNwb25zZXMgdGhhdCBmYWlsLCBsaWtlIDQwNHNcbiAgICAgICAgICAgIGlmIChyZXMuc3RhdHVzQ29kZSA+PSA0MDApIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHJlamVjdChgRXJyb3IgZG93bmxvYWRpbmcgY2hyb21lZHJpdmVyIGF0ICR7dXJsfTogJHtyZXMuc3RhdHVzQ29kZX1gKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICAgIC5waXBlKGZzLmNyZWF0ZVdyaXRlU3RyZWFtKGFyY2hpdmVQYXRoKSlcbiAgICAgICAgICAub24oJ2Nsb3NlJywgcmVzb2x2ZSk7XG4gICAgICB9KTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBjb25zdCBtc2cgPSBgQ2Fubm90IGRvd25sb2FkIGNocm9tZWRyaXZlciBhcmNoaXZlLiBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YDtcbiAgICAgIGlmIChpc1N0cmljdCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IobXNnKTtcbiAgICAgIH1cbiAgICAgIGxvZy5lcnJvcihtc2cpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBpZiAoIWF3YWl0IGlzQ3JjT2soYXJjaGl2ZVBhdGgsIGV0YWcpKSB7XG4gICAgICBjb25zdCBtc2cgPSBgVGhlIGNoZWNrc3VtIGZvciB0aGUgZG93bmxvYWRlZCBjaHJvbWVkcml2ZXIgJyR7ZHJpdmVyS2V5fScgZGlkIG5vdCBtYXRjaGA7XG4gICAgICBpZiAoaXNTdHJpY3QpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKG1zZyk7XG4gICAgICB9XG4gICAgICBsb2cuZXJyb3IobXNnKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgY29uc3QgZmlsZU5hbWUgPSBgJHtwYXRoLnBhcnNlKHVybCkubmFtZX1fdiR7dmVyc2lvbn1gICtcbiAgICAgIChzeXN0ZW0uaXNXaW5kb3dzKCkgPyAnLmV4ZScgOiAnJyk7XG4gICAgY29uc3QgdGFyZ2V0UGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLmNocm9tZWRyaXZlckRpciwgZmlsZU5hbWUpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLnVuemlwRHJpdmVyKGFyY2hpdmVQYXRoLCB0YXJnZXRQYXRoKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBpZiAoaXNTdHJpY3QpIHtcbiAgICAgICAgdGhyb3cgZTtcbiAgICAgIH1cbiAgICAgIGxvZy5lcnJvcihlLm1lc3NhZ2UpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAdHlwZWRlZiB7T2JqZWN0fSBTeW5jT3B0aW9uc1xuICAgKiBAcHJvcGVydHkge0FycmF5PFN0cmluZz59IHZlcnNpb25zIC0gVGhlIGxpc3Qgb2YgY2hyb21lZHJpdmVyXG4gICAqIHZlcnNpb25zIHRvIHN5bmMuIElmIGVtcHR5ICh0aGUgZGVmYXVsdCB2YWx1ZSkgdGhlbiBhbGwgYXZhaWxhYmxlXG4gICAqIGNocm9tZWRyaXZlcnMgYXJlIGdvaW5nIHRvIGJlIGRvd25sb2FkZWQgYW5kIGV4dHJhY3RlZFxuICAgKiBAcHJvcGVydHkge3N0cmluZ3xudW1iZXJ9IG1pbkJyb3dzZXJWZXJzaW9uIC0gVGhlIG1pbnVtdW0gc3VwcG9ydGVkXG4gICAqIENocm9tZSB2ZXJzaW9uIHRoYXQgZG93bmxvYWRlZCBjaHJvbWVkcml2ZXJzIHNob3VsZCBzdXBwb3J0LiBDYW4gbWF0Y2hcbiAgICogbXVsdGlwbGUgZHJpdmVycy5cbiAgICovXG5cbiAgLyoqXG4gICAqIFJldHJpZXZlcyBjaHJvbWVkcml2ZXJzIGZyb20gdGhlIHJlbW90ZSBzdG9yYWdlXG4gICAqIHRvIHRoZSBsb2NhbCBmaWxlIHN5c3RlbVxuICAgKlxuICAgKiBAcGFyYW0gez9TeW5jT3B0aW9uc30gb3B0c1xuICAgKiBAdGhyb3dzIHtFcnJvcn0gaWYgdGhlcmUgd2FzIGEgcHJvYmxlbSB3aGlsZSByZXRyaWV2aW5nXG4gICAqIHRoZSBkcml2ZXJzXG4gICAqIEByZXR1cm5zIHtBcnJheTxTdHJpbmd9IFRoZSBsaXN0IG9mIHN1Y2Nlc3NmdWxseSBzeW5jaHJvbml6ZWQgZHJpdmVyIGtleXNcbiAgICovXG4gIGFzeW5jIHN5bmNEcml2ZXJzIChvcHRzID0ge30pIHtcbiAgICBpZiAoXy5pc0VtcHR5KHRoaXMubWFwcGluZykpIHtcbiAgICAgIGF3YWl0IHRoaXMucmV0cmlldmVNYXBwaW5nKCEhb3B0cy5taW5Ccm93c2VyVmVyc2lvbik7XG4gICAgfVxuICAgIGlmIChfLmlzRW1wdHkodGhpcy5tYXBwaW5nKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgcmV0cmlldmUgY2hyb21lZHJpdmVycyBtYXBwaW5nIGZyb20gR29vZ2xlIHN0b3JhZ2UnKTtcbiAgICB9XG5cbiAgICBjb25zdCBkcml2ZXJzVG9TeW5jID0gdGhpcy5zZWxlY3RNYXRjaGluZ0RyaXZlcnMoYXdhaXQgZ2V0T3NJbmZvKCksIG9wdHMpO1xuICAgIGlmIChfLmlzRW1wdHkoZHJpdmVyc1RvU3luYykpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgVGhlcmUgYXJlIG5vIGRyaXZlcnMgdG8gc3luYy4gRXhpdGluZ2ApO1xuICAgICAgcmV0dXJuIFtdO1xuICAgIH1cbiAgICBsb2cuZGVidWcoYEdvdCAke2RyaXZlcnNUb1N5bmMubGVuZ3RofSBkcml2ZXIke2RyaXZlcnNUb1N5bmMubGVuZ3RoID09PSAxID8gJycgOiAncyd9IHRvIHN5bmM6IGAgK1xuICAgICAgSlNPTi5zdHJpbmdpZnkoZHJpdmVyc1RvU3luYywgbnVsbCwgMikpO1xuXG4gICAgY29uc3Qgc3luY2hyb25pemVkRHJpdmVycyA9IFtdO1xuICAgIGNvbnN0IHByb21pc2VzID0gW107XG4gICAgY29uc3QgYXJjaGl2ZXNSb290ID0gYXdhaXQgdGVtcERpci5vcGVuRGlyKCk7XG4gICAgdHJ5IHtcbiAgICAgIGZvciAoY29uc3QgW2lkeCwgZHJpdmVyS2V5XSBvZiBkcml2ZXJzVG9TeW5jLmVudHJpZXMoKSkge1xuICAgICAgICBwcm9taXNlcy5wdXNoKChhc3luYyAoKSA9PiB7XG4gICAgICAgICAgaWYgKGF3YWl0IHRoaXMucmV0cmlldmVEcml2ZXIoaWR4LCBkcml2ZXJLZXksIGFyY2hpdmVzUm9vdCwgIV8uaXNFbXB0eShvcHRzKSkpIHtcbiAgICAgICAgICAgIHN5bmNocm9uaXplZERyaXZlcnMucHVzaChkcml2ZXJLZXkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSkoKSk7XG5cbiAgICAgICAgaWYgKHByb21pc2VzLmxlbmd0aCAlIE1BWF9QQVJBTExFTF9ET1dOTE9BRFMgPT09IDApIHtcbiAgICAgICAgICBhd2FpdCBCLmFsbChwcm9taXNlcyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGF3YWl0IEIuYWxsKHByb21pc2VzKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgYXdhaXQgZnMucmltcmFmKGFyY2hpdmVzUm9vdCk7XG4gICAgfVxuICAgIGlmICghXy5pc0VtcHR5KHN5bmNocm9uaXplZERyaXZlcnMpKSB7XG4gICAgICBsb2cuaW5mbyhgU3VjY2Vzc2Z1bGx5IHN5bmNocm9uaXplZCAke3N5bmNocm9uaXplZERyaXZlcnMubGVuZ3RofSBgICtcbiAgICAgICAgYGNocm9tZWRyaXZlciR7c3luY2hyb25pemVkRHJpdmVycy5sZW5ndGggPT09IDEgPyAnJyA6ICdzJ31gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLmluZm8oYE5vIGNocm9tZWRyaXZlcnMgd2VyZSBzeW5jaHJvbml6ZWRgKTtcbiAgICB9XG4gICAgcmV0dXJuIHN5bmNocm9uaXplZERyaXZlcnM7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgQ2hyb21lZHJpdmVyU3RvcmFnZUNsaWVudDsiXSwiZmlsZSI6ImxpYi9zdG9yYWdlLWNsaWVudC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
